<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Scanner MWE — sendData</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{color-scheme:dark}
    html,body{height:100%} body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    main{display:flex;flex-direction:column;gap:12px;padding:16px}
    button{height:44px;border:none;border-radius:12px;font-weight:700;font-size:16px}
    #sendBtn{background:#00a884;color:#fff}
    #closeBtn{background:#222;color:#ddd}
    pre{background:#0b0b0b;border:1px solid #2a2a2a;border-radius:12px;padding:8px;font:12px/1.35 ui-monospace,Menlo,Consolas,monospace;max-height:40vh;overflow:auto}
    input{height:44px;border-radius:12px;border:1px solid #2a2a2a;background:#111;color:#fff;padding:0 12px;font-size:16px}
  </style>
</head>
<body>
  <main>
    <h3>Scanner MWE</h3>
    <div id="status">Ініціалізація…</div>
    <input id="code" placeholder="Тестовий код (впиши або підставимо зі сканера)" />
    <div style="display:flex; gap:12px;">
      <button id="sendBtn">Надіслати у бот</button>
      <button id="closeBtn">Закрити</button>
    </div>
    <pre id="log"></pre>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const log = (tag, msg) => {
      const line = `[${new Date().toLocaleTimeString()}] ${tag}: ${msg}`;
      console.log(line);
      const el = $('#log'); el.textContent = (el.textContent + "\n" + line).slice(-8000);
    };
    const status = (m) => { $('#status').textContent = m; log('STATUS', m); };

    // helper
    function getTG(){
      try{
        const tg = window.Telegram?.WebApp || window.parent?.Telegram?.WebApp || window.opener?.Telegram?.WebApp;
        if (tg){
          try{ tg.ready?.(); }catch(_){}
          log('TG', 'detected YES | platform='+(tg.platform||'?'));
          log('TG', 'initData.len=' + ((tg.initData||'').length||0) + ' user=' + (tg.initDataUnsafe?.user?.id || 'none'));
          return tg;
        }
      }catch(e){ log('TG','err '+(e.message||e)); }
      log('TG','detected NO'); return null;
    }

    let TG = null;

    async function sendToBotManual(){
      TG = TG || getTG();
      if (!TG){ status('❗ Відкрий через кнопку в Telegram (WebApp). Зараз сторінка поза Telegram.'); return; }
      const val = String($('#code').value || '').trim();
      if (!val){ status('Введи код у поле (для тесту)'); return; }

      const payload = JSON.stringify({ action:'handleScan', code: val, _debug_ts: Date.now() });
      log('SEND', 'sendData ' + payload);
      try{
        TG.HapticFeedback?.impactOccurred?.('light');
        TG.sendData?.(payload);
        status('Відправлено через sendData (перевір чат) — WebApp НЕ закриваю.');
        // TG.close?.(); // не закриваємо, щоб бачити ефект
      }catch(e){
        status('Помилка TG.sendData: ' + (e.message||e));
        log('SEND','err '+(e.message||e));
      }
    }

    (function init(){
      TG = getTG();
      if (!TG){
        status('❗ Відкрий через кнопку в Telegram (WebApp).');
      }else{
        try{ TG.expand?.(); TG.MainButton?.enable?.(); }catch(_){}
        status('Готово. Введи код і натисни "Надіслати у бот".');
      }
      $('#sendBtn').onclick = sendToBotManual;
      $('#closeBtn').onclick = () => { try{ TG?.close?.(); }catch(_){ window.close(); } };
    })();
  </script>
</body>
</html>
