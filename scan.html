<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Batch-—Å–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—ñ–≤</title>
  <style>
    :root{--pad:12px}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{padding:var(--pad);font-weight:600}
    #wrap{display:flex;flex-direction:column;height:100vh}
    #video{width:100%;max-height:60vh;background:#000}
    #toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:var(--pad)}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#f6f7f8;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    #status{padding:var(--pad);color:#555}
    #list{padding:var(--pad);height:20vh;overflow:auto;border-top:1px solid #eee;font-family:ui-monospace,Consolas,monospace}
    .ok{color:#087f23}.err{color:#b00020}
    .chip{display:inline-block;margin:2px 6px 2px 0;padding:3px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;background:#fafafa}
  </style>
</head>
<body>
  <div id="wrap">
    <header>–°–∫–∞–Ω—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∏ (Code-128 / EAN-13) ‚Äî batch —Ä–µ–∂–∏–º</header>
    <video id="video" playsinline></video>

    <div id="toolbar">
      <button id="btnTorch" disabled>üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
      <button id="btnPause" disabled>‚è∏Ô∏è –ü–∞—É–∑–∞</button>
      <button id="btnResume" disabled>‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
      <button id="btnClear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
      <button id="btnFinish">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ (–≤ –±–æ—Ç)</button>
      <span id="counter" class="chip">0 –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ</span>
      <span id="sent" class="chip">0 –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ</span>
      <span id="errors" class="chip">0 –ø–æ–º–∏–ª–æ–∫</span>
    </div>

    <div id="status">–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶ (–≤—ñ–¥–∫—Ä–∏–≤–∞–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram-–±–æ—Ç—ñ)</div>
    <div id="list"></div>
  </div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // ===== CONFIG =====
    const APPSCRIPT_URL = "YOUR_APPSCRIPT_URL_WITH_TOKEN"; // <- –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤—ñ–π exec?token=XYZ

    // Telegram Mini App bridge
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) tg.expand();

    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const btnTorch = document.getElementById('btnTorch');
    const btnPause = document.getElementById('btnPause');
    const btnResume = document.getElementById('btnResume');
    const btnClear = document.getElementById('btnClear');
    const btnFinish = document.getElementById('btnFinish');
    const counterEl = document.getElementById('counter');
    const sentEl = document.getElementById('sent');
    const errorsEl = document.getElementById('errors');

    // –î–µ–¥—É–ø —Ç–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
    const scanned = [];         // —É—Å—ñ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω—ñ (–ø–æ—Ä—è–¥–æ–∫)
    const seen = new Set();     // –¥–ª—è –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó
    const cooldownMs = 1200;    // —ñ–≥–Ω–æ—Ä–∏—Ç–∏ –ø–æ–≤—Ç–æ—Ä –∫–æ–¥—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ü—å–æ–≥–æ –≤—ñ–∫–Ω–∞
    const lastSeenAt = new Map();
    let sentCount = 0, errCount = 0;

    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ZXing: 1D only + TRY_HARDER
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.UPC_A,
    ]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

    const reader = new ZXing.BrowserMultiFormatReader(hints, 400);
    let currentTrack = null;
    let paused = false;

    function uiCounts(){
      counterEl.textContent = `${scanned.length} –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ`;
      sentEl.textContent = `${sentCount} –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ`;
      errorsEl.textContent = `${errCount} –ø–æ–º–∏–ª–æ–∫`;
    }
    function addRow(text, cls=""){
      const div = document.createElement('div');
      if(cls) div.className = cls;
      div.textContent = text;
      listEl.prepend(div);
    }

    // –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –Ω–∞–ø—Ä—è–º—É —É Google Apps Script (—à–≤–∏–¥—à–µ, –Ω—ñ–∂ —á–µ—Ä–µ–∑ –±–æ—Ç–∞)
    async function sendToSheet(code){
      try{
        const payload = {
          code,
          user_id: tg?.initDataUnsafe?.user?.id || "",
          username: tg?.initDataUnsafe?.user?.username || "",
          full_name: [tg?.initDataUnsafe?.user?.first_name||"", tg?.initDataUnsafe?.user?.last_name||""].join(" ").trim(),
          source: "webapp-batch",
          ts: Date.now()
        };
        const resp = await fetch(APPSCRIPT_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload),
        });
        const data = await resp.json().catch(()=> ({}));
        if (data.status === "ok"){
          sentCount++; uiCounts();
          const tag = data.found ? "‚úÖ –∑–Ω–∞–π–¥–µ–Ω–æ" : "‚ùå –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
          addRow(`${tag}: ${code} ${data.found ? `(${data.item?.name||""})` : ""}`);
        } else {
          errCount++; uiCounts();
          addRow(`‚ö†Ô∏è –ø–æ–º–∏–ª–∫–∞ Apps Script –¥–ª—è ${code}`, "err");
        }
      }catch(e){
        errCount++; uiCounts();
        addRow(`‚ö†Ô∏è –ø–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –¥–ª—è ${code}`, "err");
        console.error(e);
      }
    }

    async function startScanner(){
      statusEl.textContent = tg ? "–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶" : "‚ùó –í—ñ–¥–∫—Ä–∏–π —Å–∫–∞–Ω–µ—Ä —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram-–±–æ—Ç—ñ (—ñ–Ω–∞–∫—à–µ –±–æ—Ç –Ω–µ –æ—Ç—Ä–∏–º–∞—î –ø—ñ–¥—Å—É–º–æ–∫).";
      btnTorch.disabled = true; btnPause.disabled = true; btnResume.disabled = true;

      try {
        // –Ø–∫—ñ—Å–Ω–∏–π —Å—Ç—Ä—ñ–º: —Ç–∏–ª–æ–≤–∞ –∫–∞–º–µ—Ä–∞, HD
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 }, height: { ideal: 720 },
            advanced: [{ focusMode: "continuous" }]
          },
          audio: false
        });
        video.srcObject = stream; await video.play();
        currentTrack = stream.getVideoTracks()[0];

        // Torch –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å
        const caps = currentTrack.getCapabilities?.(); 
        if (caps && 'torch' in caps) btnTorch.disabled = false;

        // –ó–∞–ø—É—Å–∫ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è
        const devices = await reader.listVideoInputDevices();
        const back = devices.find(d => /back|rear|environment/i.test(d.label));
        const deviceId = back ? back.deviceId : (devices[0]?.deviceId || null);

        await reader.decodeFromVideoDevice(deviceId, video, (result, err) => {
          if (paused) return;
          if (result){
            const code = String(result.getText()||"").trim();
            const now = Date.now();
            const last = lastSeenAt.get(code) || 0;
            if (now - last < cooldownMs) return; // –∞–Ω—Ç–∏-–¥—É–±–ª—å
            lastSeenAt.set(code, now);

            scanned.push(code);
            seen.add(code);
            uiCounts();
            try { navigator.vibrate && navigator.vibrate(25); } catch(_){}

            // –ú–ò–¢–¢–Ñ–í–û —à–ª–µ–º–æ —É Google Sheets ‚Äî –∫–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è
            if (APPSCRIPT_URL.startsWith("http")) sendToSheet(code);
            addRow(`üì¶ ${code}`, "ok");
          }
        });

        btnPause.disabled = false;
        btnResume.disabled = true;
        statusEl.textContent = "–ù–∞–≤–æ–¥—å –∫–∞–º–µ—Ä—É (—Ç—Ä–∏–º–∞–π –∫–æ–¥ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –ø—ñ–¥—Å–≤—ñ—Ç–∏ –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ).";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä HTTPS —Ç–∞ –¥–æ–∑–≤—ñ–ª.";
      }
    }

    async function stopScanner(){
      try { await reader.reset(); } catch(_){}
      try { await video.pause(); } catch(_){}
      try { currentTrack && currentTrack.stop(); } catch(_){}
      btnTorch.disabled = true;
    }

    // –ö–ù–û–ü–ö–ò
    btnTorch.addEventListener('click', async () => {
      try{
        const caps = currentTrack.getCapabilities?.();
        if (caps && 'torch' in caps){
          const set = currentTrack.getSettings();
          await currentTrack.applyConstraints({ advanced: [{ torch: !set.torch }] });
        }
      }catch(e){ console.warn("Torch not supported", e); }
    });

    btnPause.addEventListener('click', () => {
      paused = true;
      btnPause.disabled = true; btnResume.disabled = false;
      statusEl.textContent = "‚è∏Ô∏è –ü–∞—É–∑–∞. –ù–∞—Ç–∏—Å–Ω–∏ ¬´–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏¬ª, —â–æ–± —Å–∫–∞–Ω—É–≤–∞—Ç–∏ –¥–∞–ª—ñ.";
    });

    btnResume.addEventListener('click', () => {
      paused = false;
      btnPause.disabled = false; btnResume.disabled = true;
      statusEl.textContent = "–ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ. –ù–∞–≤–æ–¥—å –Ω–∞ –∫–æ–¥‚Ä¶";
    });

    btnClear.addEventListener('click', () => {
      scanned.length = 0; seen.clear(); lastSeenAt.clear();
      sentCount = 0; errCount = 0; listEl.innerHTML = ""; uiCounts();
    });

    btnFinish.addEventListener('click', async () => {
      // –Ω–∞–¥—Å–∏–ª–∞—î–º–æ –ü–Ü–î–°–£–ú–û–ö —É –±–æ—Ç –æ–¥–Ω–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
      if (tg && tg.sendData){
        const summary = { mode: "batch", total: scanned.length, unique: seen.size, sent: sentCount, errors: errCount };
        try { tg.sendData(JSON.stringify(summary)); } catch(_){}
      }
      await stopScanner();
      statusEl.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ. –ú–æ–∂–µ—à –∑–∞–∫—Ä–∏—Ç–∏ –≤—ñ–∫–Ω–æ.";
    });

    // –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç
    startScanner();
  </script>
</body>
</html>
