<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—É ‚Äî v1.7</title>
  <style>
    :root{color-scheme:dark}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#000;color:#fff}
    header{padding:12px 16px;background:#111;display:flex;align-items:center;justify-content:space-between;gap:8px}
    header .title{font-weight:600}
    .chip{display:inline-block;font-size:12px;padding:4px 8px;border:1px solid #333;border-radius:999px;background:#1b1b1b;color:#bbb}

    /* –ö–∞–º–µ—Ä–∞ */
    #wrap{position:relative}
    #video{width:100%;height:58vh;object-fit:cover;background:#000}
    #tapOverlay{position:absolute;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35)}
    #btnTapStart{font-size:16px;padding:12px 16px;border-radius:12px;border:1px solid #666;background:#1b1b1b;color:#fff}

    /* –ú–∞—Ä–∫–µ—Ä —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è */
    #lastCode{position:absolute;left:0;right:0;top:10px;text-align:center;font:700 22px/1.2 system-ui;color:#00ff91;text-shadow:0 0 10px #000}

    /* –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å –¥—ñ–π (–º—ñ–Ω—ñ–º—É–º) */
    #miniBar{position:absolute;right:12px;bottom:12px;display:flex;gap:8px}
    .iconBtn{height:44px;min-width:44px;border-radius:12px;border:1px solid #333;background:#1b1b1b;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .iconBtn:disabled{opacity:.5;cursor:not-allowed}

    /* –ù–∏–∑ (–≤–µ–ª–∏–∫—ñ –∫–Ω–æ–ø–∫–∏) */
    #actions{position:sticky;bottom:0;display:flex;gap:10px;padding:12px 16px;background:#111;border-top:1px solid #262626}
    #btnSend{flex:1;height:56px;font-size:17px;border-radius:14px;border:1px solid #1a5fd0;background:#1f6feb;color:#fff;cursor:pointer}
    #btnSend:disabled{opacity:.5;cursor:not-allowed}
    #btnRescan{width:160px;height:56px;font-size:15px;border-radius:14px;border:1px solid #333;background:#1b1b1b;color:#fff}
    #status{padding:10px 16px;color:#cfcfcf;background:#111;border-top:1px solid #1c1c1c}

    /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –±–ª–æ–∫ –ª–æ–≥—ñ–≤ (–≤–º–∏–∫–∞—î—Ç—å—Å—è ?debug=1) */
    #debug{display:none;padding:10px 16px;font:12px/1.35 ui-monospace,Consolas,monospace;background:#0b0b0b;border-top:1px solid #222;white-space:pre-wrap;max-height:24vh;overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="title">–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—É</div>
    <span class="chip" id="tagVer">v1.7</span>
  </header>

  <div id="wrap">
    <div id="lastCode"></div>
    <video id="video" playsinline muted autoplay></video>

    <!-- iOS tap-to-play -->
    <div id="tapOverlay"><button id="btnTapStart">‚ñ∂Ô∏è –¢–æ—Ä–∫–Ω–∏—Å—å, —â–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button></div>

    <!-- –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å (—Ç—ñ–ª—å–∫–∏ –ª—ñ—Ö—Ç–∞—Ä–∏–∫) -->
    <div id="miniBar">
      <button class="iconBtn" id="btnTorch" title="–õ—ñ—Ö—Ç–∞—Ä–∏–∫" disabled>üî¶</button>
    </div>
  </div>

  <div id="actions">
    <button id="btnSend" disabled>üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –±–æ—Ç</button>
    <button id="btnRescan" disabled>üîÑ –°–∫–∞–Ω—É–≤–∞—Ç–∏ —â–µ</button>
  </div>

  <div id="status">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>
  <div id="debug"></div>

  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* --- HTTPS enforce --- */
    try{
      if(location.protocol==='http:' && location.hostname!=='localhost'){
        location.replace('https://' + location.host + location.pathname + location.search + location.hash);
      }
    }catch(_){}

    /* --- Tunables --- */
    const VERSION='v1.7';
    const SEND_DELAY_MS=150;
    const RETRIES=2, RETRY_GAP_MS=350;

    /* --- Debug toggle (?debug=1) --- */
    const params=new URLSearchParams(location.search);
    const debugMode=params.get('debug')==='1';
    const dbg=document.getElementById('debug');
    if(debugMode) dbg.style.display='block';

    function dlog(...a){
      if(!debugMode) return;
      const line=a.map(v=>{try{return typeof v==='string'?v:JSON.stringify(v)}catch{return String(v)}}).join(' ');
      const ts=new Date().toISOString().split('T')[1].replace('Z','');
      dbg.textContent += `[${ts}] ${line}\n`;
      dbg.scrollTop = dbg.scrollHeight;
      console.log('[DBG]', ...a);
    }

    /* --- Telegram bridge --- */
    const tg=(window.Telegram&&window.Telegram.WebApp)?window.Telegram.WebApp:null;
    if(tg){tg.expand();tg.ready&&tg.ready(); dlog("TG WebApp", tg.platform, tg.version, VERSION)}
    else {dlog("TG WebApp NOT detected ‚Äî –≤—ñ–¥–∫—Ä–∏–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç—ñ")}

    /* --- UI refs --- */
    const video=document.getElementById('video');
    const statusEl=document.getElementById('status');
    const lastCodeEl=document.getElementById('lastCode');
    const tapOverlay=document.getElementById('tapOverlay');
    const btnTapStart=document.getElementById('btnTapStart');
    const btnSend=document.getElementById('btnSend');
    const btnRescan=document.getElementById('btnRescan');
    const btnTorch=document.getElementById('btnTorch');

    function setStatus(t){ statusEl.textContent=t; dlog('STATUS:', t); }
    function showOverlay(b){ tapOverlay.style.display=b?'flex':'none'; }
    function showHit(code){ lastCodeEl.textContent=`‚úì ${code}`; lastCodeEl.style.color='#00ff91'; }

    /* --- ZXing --- */
    const hints=new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.UPC_A,
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.ITF,
      ZXing.BarcodeFormat.CODE_39
    ]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER,true);
    hints.set(ZXing.DecodeHintType.ASSUME_GS1,true);
    const reader=new ZXing.BrowserMultiFormatReader(hints,500);

    let currentTrack=null, chosenDeviceId=null, gotCode=false, lastPayload=null;

    const errStats={NotFound:0,Checksum:0,Format:0,Other:0};
    let lastErrLogTs=0;
    function onDecodeError(err){
      if(!err) return;
      if(err instanceof ZXing.NotFoundException) errStats.NotFound++;
      else if(err instanceof ZXing.ChecksumException) errStats.Checksum++;
      else if(err instanceof ZXing.FormatException)  errStats.Format++;
      else errStats.Other++;

      const now=performance.now();
      if(now-lastErrLogTs>1200){
        lastErrLogTs=now;
        const hint = errStats.Checksum>errStats.NotFound
          ? '–î–æ–¥–∞–π —Å–≤—ñ—Ç–ª–∞ –∞–±–æ –ø—Ä–∏–±–µ—Ä–∏ –±–ª—ñ–∫–∏.'
          : (errStats.Format>errStats.NotFound
            ? '–ú–æ–∂–ª–∏–≤–æ, —Ü–µ –Ω–µ EAN/UPC/ITF/Code128.'
            : '–¢—Ä–∏–º–∞–π —à—Ç—Ä–∏—Ö–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –∑–∞–π–º–∏ ~70% —à–∏—Ä–∏–Ω–∏ –∫–∞–¥—Ä—É.');
        setStatus(`–ü–æ—à—É–∫ –∫–æ–¥—É‚Ä¶ ${hint}`);
        dlog('decode stats', JSON.stringify(errStats));
      }
    }

    function preferDevice(devs){
      // –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: telephoto/back ‚Üí –ø—Ä–æ—Å—Ç–æ back ‚Üí —ñ–Ω—à—ñ
      const isUW = l=>/ultra|ultra[- ]?wide|uw|0\.5x|0,5x|–Ω–∞–¥—à–∏—Ä/i.test(l||'');
      const isTele = l=>/tele|telephoto|2x|3x|5x|10x/i.test(l||'');
      const isBack = l=>/back|rear|environment|—Ç–∏–ª–æ–≤|–∑–∞–¥–Ω/i.test(l||'');
      const rank = l => (isTele(l)&&isBack(l))?3 : (isBack(l)&&!isUW(l))?2 : isUW(l)?1 : 0;
      return [...devs].sort((a,b)=>rank(b.label)-rank(a.label))[0];
    }

    async function enumerateCams(){
      const devs=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
      const saved=localStorage.getItem('scanner.preferredDeviceId');
      let preferred = devs.find(d=>d.deviceId===saved) || preferDevice(devs) || devs[0];
      chosenDeviceId = preferred && preferred.deviceId;
      dlog('Devices:', devs.map(d=>({label:d.label, id:d.deviceId})));
      dlog('Chosen deviceId:', chosenDeviceId, 'label:', preferred && preferred.label);
    }

    async function tuneTrack(){
      try{
        const caps=currentTrack?.getCapabilities?.(); if(!caps) return;
        if(caps.zoom){
          const mid=Math.min(caps.zoom.max||2.5, Math.max(caps.zoom.min||1.5, 2));
          await currentTrack.applyConstraints({advanced:[{zoom:mid}]});
        }
        if(caps.focusMode?.includes?.('continuous')){
          await currentTrack.applyConstraints({advanced:[{focusMode:'continuous'}]});
        }
      }catch(e){ dlog('tune error', e?.message); }
    }

    async function decodeWithDevice(deviceId){
      setStatus('–ó–∞–ø—É—Å–∫–∞—é –¥–µ–∫–æ–¥–µ—Ä‚Ä¶');
      const constraints = {
        video: {
          deviceId: deviceId?{exact:deviceId}:undefined,
          facingMode: {ideal:'environment'},
          width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30},
          advanced:[{focusMode:'continuous'}]
        },
        audio:false
      };

      reader.decodeFromConstraints(constraints, video, (result, err)=>{
        if(gotCode) return;
        if(result){
          const code=String(result.getText()||'').trim();
          const fmt =String(result.getBarcodeFormat?.()||'UNKNOWN');
          gotCode=true; lastPayload={code,fmt};
          showHit(code);
          setStatus(`–ó—á–∏—Ç–∞–Ω–æ: ${code} (${fmt}). –ù–∞—Ç–∏—Å–Ω–∏ ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –±–æ—Ç¬ª.`);
          btnSend.disabled=false; btnRescan.disabled=false;
          try{navigator.vibrate && navigator.vibrate(25)}catch(_){}
        } else if(err){ onDecodeError(err); }
      });

      let tries=0; while(!video.srcObject && tries++<60){ await new Promise(r=>setTimeout(r,100)); }
      currentTrack = video.srcObject?.getVideoTracks?.()[0] || null;
      await tuneTrack();

      if(video.paused){ try{ await video.play(); }catch{} }
      const caps=currentTrack?.getCapabilities?.();
      btnTorch.disabled = !(caps && 'torch' in caps);

      setStatus('–ù–∞–≤–æ–¥—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ —É —Ä–∞–º–∫—É‚Ä¶');
      setTimeout(()=>{ if(!video.srcObject || video.paused || video.readyState<2){ showOverlay(true); } }, 300);
    }

    async function startCamera(){
      setStatus('–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶');
      try{
        // –î–æ—á–µ–∫–∞—î–º–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ZXing
        let t=0; while((!window.ZXing||!ZXing.BrowserMultiFormatReader) && t++<20){ await new Promise(r=>setTimeout(r,100)); }
        // –†–∞–∑–æ–≤–∏–π –∑–∞–ø–∏—Ç –¥–æ–∑–≤–æ–ª—É ‚Äî —â–æ–± –∑‚Äô—è–≤–∏–ª–∏—Å—å –Ω–∞–∑–≤–∏ –∫–∞–º–µ—Ä
        try{ const tmp=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); tmp.getTracks().forEach(t=>t.stop()); }catch(e){}
        await enumerateCams();
        if(!chosenDeviceId) throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥–µ–æ–∫–∞–º–µ—Ä–∏');
        await decodeWithDevice(chosenDeviceId);
      }catch(e){
        dlog('startCamera error', e?.message||e);
        setStatus('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä HTTPS/–¥–æ–∑–≤—ñ–ª.');
        showOverlay(true);
      }
    }

    async function stopAll(){
      try{ await reader.reset(); }catch(e){}
      try{ await video.pause(); }catch(e){}
      const s=video.srcObject;
      if(s&&s.getTracks){ s.getTracks().forEach(t=>{ try{t.stop()}catch{} }); }
      video.srcObject=null; currentTrack=null;
      btnTorch.disabled=true;
    }

    /* --- Torch --- */
    btnTorch.addEventListener('click', async ()=>{
      try{
        const caps=currentTrack?.getCapabilities?.();
        if(!(caps && 'torch' in caps)) return;
        const set=currentTrack.getSettings();
        await currentTrack.applyConstraints({advanced:[{torch:!set.torch}]});
      }catch(e){ dlog('torch error', e?.message||e); }
    });

    /* --- Manual send --- */
    btnSend.addEventListener('click', async ()=>{
      if(!lastPayload) return;
      const payload = JSON.stringify({ t:'barcode', fmt:lastPayload.fmt, code:lastPayload.code });
      let sent=false;

      if(tg?.sendData){
        await new Promise(r=>setTimeout(r, SEND_DELAY_MS));
        for(let i=0;i<=RETRIES;i++){
          try{ tg.sendData(payload); sent=true; break; }
          catch(e){ await new Promise(r=>setTimeout(r, RETRY_GAP_MS)); }
        }
        try{ tg.close && tg.close(); }catch(_){}
      }else{
        await navigator.clipboard?.writeText?.(lastPayload.code);
        alert(`–ö–æ–¥: ${lastPayload.code}\n(–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É)`);
        sent=true;
      }

      await stopAll();
      btnSend.disabled=true;
      setStatus(sent ? '‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç. –ú–æ–∂–µ—à –∑–∞–∫—Ä–∏—Ç–∏ –≤—ñ–∫–Ω–æ.' : '‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.');
    });

    btnRescan.addEventListener('click', async ()=>{
      gotCode=false; lastPayload=null; lastCodeEl.textContent='';
      btnSend.disabled=true; btnRescan.disabled=true;
      await stopAll(); await startCamera();
    });

    /* --- iOS tap overlay --- */
    btnTapStart.addEventListener('click', async ()=>{
      showOverlay(false);
      if(!video.srcObject){ await startCamera(); }
      try{ await video.play(); }catch(e){}
    });

    window.addEventListener('beforeunload', stopAll);

    (async ()=>{
      document.getElementById('tagVer').textContent = VERSION;
      video.setAttribute('playsinline',''); video.muted = true;
      await startCamera();
    })();
  </script>
</body>
</html>
