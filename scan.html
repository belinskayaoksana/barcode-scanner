@dp.message_handler(content_types=["web_app_data"])
async def on_webapp_data(message: types.Message):
    code = (message.web_app_data.data or "").strip()
    if not code:
        return await message.answer("⚠️ Порожній код. Спробуй ще раз.")

    # 1) Пишемо в Sheets + шукаємо ТМЦ через Apps Script
    try:
        payload = {
            "code": code,
            "user_id": message.from_user.id,
            "username": message.from_user.username or "",
            "full_name": f"{message.from_user.first_name or ''} {message.from_user.last_name or ''}".strip(),
            "source": "webapp-single",
        }
        r = requests.post(APPSCRIPT_URL, json=payload, timeout=12)
        r.raise_for_status()
        data = r.json()
    except Exception as e:
        return await message.answer(f"⚠️ Помилка Apps Script: {e}")

    # 2) Відповідь користувачу
    if data.get("status") == "ok" and data.get("found"):
        item = data.get("item", {}) or {}
        name = item.get("name","")
        sku = item.get("sku","")
        storage = item.get("storage","")
        await message.answer(
            f"✅ Знайдено\n"
            f"• Код: {code}\n"
            f"• Назва: {name}\n"
            f"• SKU: {sku}\n"
            f"• Склад: {storage}"
        )
    else:
        await message.answer(f"❌ Не знайдено в довіднику. Код {code} записано у лог.")
