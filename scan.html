<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—É</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#000;color:#fff}
    header{padding:12px 16px;font-weight:600;background:#111}
    #video{width:100%;height:calc(100vh - 140px);object-fit:cover;background:#000}
    #bar{display:flex;gap:8px;align-items:center;padding:10px 16px;background:#111}
    button{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#1b1b1b;color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    #status{padding:10px 16px;color:#ccc;background:#111}
    #cameraList{margin-left:auto;padding:8px 10px;border-radius:8px;border:1px solid #444;background:#1b1b1b;color:#fff;display:none}
  </style>
</head>
<body>
  <header>–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ (EAN-13 / Code-128)</header>
  <video id="video" playsinline muted autoplay></video>
  <div id="bar">
    <button id="btnTorch" disabled>üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
    <button id="btnRestart" disabled>üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏</button>
    <select id="cameraList" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É"></select>
  </div>
  <div id="status">–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶</div>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) tg.expand(); else {
      document.body.insertAdjacentHTML('afterbegin',
        '<div style="position:fixed;top:0;left:0;right:0;background:#b00020;color:#fff;padding:10px 16px;font-weight:600">–í—ñ–¥–∫—Ä–∏–π —Å–∫–∞–Ω–µ—Ä —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram-–±–æ—Ç—ñ ‚Äî —ñ–Ω–∞–∫—à–µ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç –Ω–µ —Å–ø—Ä–∞—Ü—é—î.</div>');
    }

    const video      = document.getElementById('video');
    const statusEl   = document.getElementById('status');
    const btnTorch   = document.getElementById('btnTorch');
    const btnRestart = document.getElementById('btnRestart');
    const cameraList = document.getElementById('cameraList');

    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.UPC_A,
    ]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
    const reader = new ZXing.BrowserMultiFormatReader(hints, 400);

    let currentTrack = null;
    let stopping = false;

    function setStatus(t){ statusEl.textContent = t; }

    async function stopAll(){
      try { await reader.reset(); } catch(_){}
      try { await video.pause(); } catch(_){}
      if (currentTrack) { try { currentTrack.stop(); } catch(_){ } }
      btnTorch.disabled = true;
    }

    async function populateCameraList(devs){
      if (!devs || !devs.length) {
        cameraList.style.display = "none";
        return;
      }
      cameraList.innerHTML = devs.map((d,i)=>{
        const lbl = d.label || `–ö–∞–º–µ—Ä–∞ ${i+1}`;
        const hint = /back|rear|environment/i.test(lbl) ? " (—Ç–∏–ª–æ–≤–∞)" : "";
        return `<option value="${d.deviceId}">${lbl}${hint}</option>`;
      }).join("");
      cameraList.style.display = devs.length > 1 ? "block" : "none";
    }

    async function startDecodeWithDevice(deviceId){
      // –°—Ç–∞—Ä—Ç—É—î–º–æ –ø–æ—Ç—ñ–∫ –°–ê–ú–ï –∑ –ø–æ—Ç—Ä—ñ–±–Ω–æ–≥–æ deviceId (—î–¥–∏–Ω–∏–π —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Å—Ç—Ä—ñ–º)
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      currentTrack = stream.getVideoTracks()[0];

      // Torch, —è–∫—â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è
      try {
        const caps = currentTrack?.getCapabilities?.();
        if (caps && 'torch' in caps) btnTorch.disabled = false;
      } catch(_){}

      await reader.decodeFromVideoDevice(deviceId, video, (result, err) => {
        if (stopping) return;
        if (result){
          stopping = true;
          const code = String(result.getText()||"").trim();
          setStatus(`–ó—á–∏—Ç–∞–Ω–æ: ${code}. –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –≤ –±–æ—Ç‚Ä¶`);
          try { navigator.vibrate && navigator.vibrate(40); } catch(_){}
          stopAll().finally(()=> { if (tg && tg.sendData) tg.sendData(code); });
        }
      });
    }

    async function startCamera(){
      setStatus("–ó–∞–ø–∏—Ç—É—é –¥–æ–∑–≤—ñ–ª –¥–æ –∫–∞–º–µ—Ä–∏‚Ä¶");
      btnTorch.disabled = true; btnRestart.disabled = true;

      try {
        // 1) –ü—Ä–æ—Å–∏–º–æ –±—É–¥—å-—è–∫—É –∫–∞–º–µ—Ä—É –¢–Ü–õ–¨–ö–ò —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ permission —ñ labels
        let tmp = null;
        try {
          tmp = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } }, audio: false
          });
        } catch {
          tmp = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        }

        // –ù–µ –ø–æ–∫–∞–∑—É—î–º–æ —Ü–µ–π —Ç–∏–º—á–∞—Å–æ–≤–∏–π –ø–æ—Ç—ñ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É ‚Äî –æ–¥—Ä–∞–∑—É –∑—É–ø–∏–Ω—è—î–º–æ
        tmp.getTracks().forEach(t=>t.stop());

        // 2) –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –∑ labels —ñ –∑–Ω–∞—Ö–æ–¥–∏–º–æ —Ç–∏–ª–æ–≤—É
        const devices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==="videoinput");
        await populateCameraList(devices);

        let back = devices.find(d => /back|rear|environment/i.test(d.label));
        if (!back) back = devices[devices.length - 1]; // fallback: –æ—Å—Ç–∞–Ω–Ω—è —á–∞—Å—Ç–æ —Ç–∏–ª–æ–≤–∞ –≤ WebView

        // 3) –Ø–∫—â–æ –∑–Ω–∞–π—à–ª–∏ ‚Äî —Å—Ç–∞—Ä—Ç—É—î–º–æ –û–î–ò–ù —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Å—Ç—Ä—ñ–º —Ç—ñ–ª—å–∫–∏ –∑ —Ü–∏–º deviceId
        if (back?.deviceId) {
          await startDecodeWithDevice(back.deviceId);
        } else {
          // —è–∫ –∫—Ä–∞–π–Ω—ñ–π –≤–∏–ø–∞–¥–æ–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä—à–∏–π –¥–µ–≤–∞–π—Å
          const first = devices[0];
          if (first?.deviceId) await startDecodeWithDevice(first.deviceId);
          else throw new Error("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ—ó –≤—ñ–¥–µ–æ–∫–∞–º–µ—Ä–∏");
        }

        btnRestart.disabled = false;
        setStatus("–ù–∞–≤–æ–¥—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –±–µ–∑ –±–ª–∏–∫—ñ–≤.");
      } catch (e) {
        console.error(e);
        setStatus("–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä HTTPS —Ç–∞ –¥–æ–∑–≤—ñ–ª.");
      }
    }

    // UI –ø–æ–¥—ñ—ó
    btnTorch.addEventListener('click', async () => {
      try{
        const caps = currentTrack?.getCapabilities?.();
        if (caps && 'torch' in caps){
          const set = currentTrack.getSettings();
          await currentTrack.applyConstraints({ advanced: [{ torch: !set.torch }] });
        }
      }catch(e){ console.warn("Torch not supported", e); }
    });

    btnRestart.addEventListener('click', async () => {
      stopping = true;
      await stopAll();
      stopping = false;
      await startCamera();
    });

    cameraList.addEventListener('change', async () => {
      const id = cameraList.value;
      if (!id) return;
      stopping = true;
      await stopAll();
      stopping = false;
      await startDecodeWithDevice(id);
    });

    // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç
    startCamera();
  </script>
</body>
</html>
