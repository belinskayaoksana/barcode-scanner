<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>–°–∫–∞–Ω–µ—Ä ‚Äî —à—Ç—Ä–∏—Ö-–∫–æ–¥ + OCR v1.8</title>
  <style>
    :root{color-scheme:dark}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#000;color:#fff}
    header{padding:12px 16px;font-weight:600;background:#111;display:flex;gap:8px;align-items:center;justify-content:space-between}
    #video{width:100%;height:44vh;object-fit:cover;background:#000}
    #status{padding:10px 16px;color:#cfcfcf;background:#111;min-height:42px}
    #bar{display:flex;gap:8px;align-items:center;padding:10px 16px;background:#111;flex-wrap:wrap}
    button{padding:12px 16px;border-radius:14px;border:1px solid #303030;background:#1b1b1b;color:#fff;cursor:pointer}
    button.primary{background:#1f6feb;border-color:#2059c7;font-weight:700;font-size:16px}
    button:disabled{opacity:.5;cursor:not-allowed}
    #cameraList{padding:8px 10px;border-radius:10px;border:1px solid #444;background:#1b1b1b;color:#fff}
    .tag{display:inline-block;margin:2px 4px 2px 0;padding:2px 6px;border:1px solid #444;border-radius:999px;font-size:12px;background:#1b1b1b}
    input[type="range"]{accent-color:#fff}
    #lastCode{position:absolute;left:0;right:0;top:8px;text-align:center;font:700 22px/1.2 system-ui;color:#00ff91;text-shadow:0 0 8px #000}
    #tapOverlay{position:absolute;left:0;right:0;top:56px;height:44vh;display:none;align-items:center;justify-content:center;pointer-events:auto;background:rgba(0,0,0,.35)}
    #tapOverlay button{font-size:16px}
    #actions{position:sticky;bottom:0;display:flex;gap:10px;padding:12px 16px;background:#111;border-top:1px solid #333}
    #btnSend{min-height:52px;flex:1}
    #btnRescan{min-width:44%;background:#262626}
    #btnOCR{min-width:44%;background:#303030}
    /* ROI overlay */
    #roiMask{position:absolute;left:0;right:0;top:56px;height:44vh;pointer-events:none}
    .mask{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .hole{position:absolute;border:2px dashed rgba(255,255,255,.6);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.35)}
    #hint{position:absolute;left:50%;transform:translateX(-50%);top:calc(56px + 44vh - 28px);font:600 12px/1 system-ui;color:#ddd;text-shadow:0 1px 2px #000}
  </style>
</head>
<body>
  <header>
    <div>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—É / —Ç–µ–∫—Å—Ç—É</div>
    <span class="tag" id="tagVer">v1.8</span>
  </header>

  <div id="lastCode"></div>
  <video id="video" playsinline muted autoplay></video>

  <!-- ROI overlay -->
  <div id="roiMask">
    <div class="mask"></div>
    <div id="roi" class="hole"></div>
  </div>
  <div id="hint">–¢—Ä–∏–º–∞–π —à—Ç—Ä–∏—Ö–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ —É —Ä–∞–º—Ü—ñ</div>

  <div id="tapOverlay">
    <button id="btnTapStart">‚ñ∂Ô∏è –¢–æ—Ä–∫–Ω—ñ—Ç—å—Å—è, —â–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
  </div>

  <div id="bar">
    <button id="btnTorch" disabled>üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
    <button id="btnRestart" disabled>üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</button>
    <select id="cameraList" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É"></select>
    <input id="zoom" type="range" min="1" max="1" step="0.1" style="width:160px; display:none;">
    <span class="tag" id="tagFacing">facing: ?</span>
    <span class="tag" id="tagRes">res: ?</span>
    <span class="tag" id="tagTorch">torch: ?</span>
    <span class="tag" id="tagZoom">zoom: n/a</span>
  </div>

  <div id="actions">
    <button id="btnOCR">üÖæÔ∏è –ó—á–∏—Ç–∞—Ç–∏ —Ç–µ–∫—Å—Ç (OCR)</button>
    <button id="btnRescan">‚Ü∫ –ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
    <button id="btnSend" class="primary" disabled>üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –±–æ—Ç</button>
  </div>

  <div id="status">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>

  <!-- libs -->
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    // ===== –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ =====
    const VERSION='v1.8';
    const ENABLE_OCR=true;
    const AUTO_OCR_TIMEOUT_MS=2500; // —á–µ—Ä–µ–∑ —Å–∫—ñ–ª—å–∫–∏ —Å–µ–∫—É–Ω–¥ –±–µ–∑—É—Å–ø—ñ—à–Ω–æ–≥–æ —Å–∫–∞–Ω—É –≤–∫–ª—é—á–∞—Ç–∏ OCR
    const SEND_DELAY_MS=150, RETRIES=2, RETRY_GAP_MS=350;

    // ROI (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –≤—ñ–¥ –≤—ñ–¥–µ–æ): 70% —à–∏—Ä–∏–Ω–∏ √ó 35% –≤–∏—Å–æ—Ç–∏
    const ROI = { x:0.15, y:0.325, w:0.70, h:0.35 };

    // ===== –¥–æ–ø–æ–º—ñ–∂–Ω—ñ =====
    const tg=(window.Telegram&&window.Telegram.WebApp)?window.Telegram.WebApp:null;
    if(tg){tg.expand();tg.ready&&tg.ready();}
    const video=document.getElementById('video'), statusEl=document.getElementById('status');
    const btnTorch=document.getElementById('btnTorch'), btnRestart=document.getElementById('btnRestart');
    const cameraList=document.getElementById('cameraList'), tagFacing=document.getElementById('tagFacing');
    const tagRes=document.getElementById('tagRes'), tagTorch=document.getElementById('tagTorch'), tagZoom=document.getElementById('tagZoom');
    const zoomEl=document.getElementById('zoom'), tapOverlay=document.getElementById('tapOverlay'), btnTapStart=document.getElementById('btnTapStart');
    const lastCodeEl=document.getElementById('lastCode'), btnSend=document.getElementById('btnSend'), btnRescan=document.getElementById('btnRescan'), btnOCR=document.getElementById('btnOCR');
    const roiEl=document.getElementById('roi'), verEl=document.getElementById('tagVer');

    function setStatus(t){statusEl.textContent=t}
    function showHit(code){lastCodeEl.textContent=`‚úì ${code}`;lastCodeEl.style.color='#00ff91'}
    verEl.textContent=VERSION;

    // –ø–æ–∑–∏—Ü—ñ–æ–Ω—É—î–º–æ ROI-—Ä–∞–º–∫—É
    function placeROI(){
      const vh=document.documentElement.clientHeight*0.44; // 44vh
      const vw=document.documentElement.clientWidth;
      const left   = Math.round(ROI.x*vw);
      const top    = Math.round(ROI.y*vh + 56); // 56px header
      const width  = Math.round(ROI.w*vw);
      const height = Math.round(ROI.h*vh);
      roiEl.style.left = left+'px';
      roiEl.style.top  = top+'px';
      roiEl.style.width= width+'px';
      roiEl.style.height= height+'px';
    }
    placeROI(); addEventListener('resize', placeROI);

    // ===== ZXing =====
    const hints=new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[
      ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A,
      ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.ITF, ZXing.BarcodeFormat.CODE_39, ZXing.BarcodeFormat.CODE_93
    ]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER,true);
    hints.set(ZXing.DecodeHintType.ASSUME_GS1,true);
    const reader=new ZXing.BrowserMultiFormatReader(hints, 350); // —Ç—Ä–æ—Ö–∏ —á–∞—Å—Ç—ñ—à–µ

    let currentTrack=null, chosenBackId=null, gotCode=false, lastPayload=null, lastTryTs=0;

    function updateTrackTags(){try{const s=currentTrack?.getSettings?.()||{};tagFacing.textContent=`facing: ${s.facingMode||"?"}`;
      tagRes.textContent=`res: ${s.width||"?"}x${s.height||"?"}`;const caps=currentTrack?.getCapabilities?.();tagTorch.textContent=`torch: ${caps&&'torch'in caps?'yes':'no'}`}catch(_){}}

    function setupZoomControl(){try{const caps=currentTrack?.getCapabilities?.();
      if(caps?.zoom){zoomEl.min=caps.zoom.min??1;zoomEl.max=caps.zoom.max??6;zoomEl.step=caps.zoom.step??0.1;
        const desired=Math.min(caps.zoom.max??3,Math.max(caps.zoom.min??1.8,2.2)); // –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ—à–∏–π –¥–µ—Ñ–æ–ª—Ç
        zoomEl.value=currentTrack.getSettings().zoom??desired;zoomEl.style.display='inline-block';tagZoom.textContent=`zoom: ${zoomEl.value}`;
        currentTrack.applyConstraints({advanced:[{zoom:Number(zoomEl.value)}]}).catch(()=>{})}
      else{zoomEl.style.display='none';tagZoom.textContent='zoom: n/a'}}catch{}}
    zoomEl.addEventListener('input', async()=>{try{await currentTrack.applyConstraints({advanced:[{zoom:Number(zoomEl.value)}]});tagZoom.textContent=`zoom: ${zoomEl.value}`}catch{}});

    function isUltraWideLabel(lbl){return /ultra|ultra[- ]?wide|uw|0\.5x|0,5x|–Ω–∞–¥—à–∏—Ä/i.test(lbl||'')}
    function isTeleLabel(lbl){return /tele|telephoto|2x|3x|5x|10x/i.test(lbl||'')}
    function isBackLabel(lbl){return /back|rear|environment|—Ç–∏–ª–æ–≤|–∑–∞–¥–Ω/i.test(lbl||'')}
    function rankCamera(label){if(isTeleLabel(label)&&isBackLabel(label))return 3;if(isBackLabel(label)&&!isUltraWideLabel(label))return 2;if(isUltraWideLabel(label))return 1;return 0}

    async function enumerateCams(){
      const devs=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==="videoinput");
      cameraList.innerHTML=devs.map((d,i)=>{const lbl=d.label||`–ö–∞–º–µ—Ä–∞ ${i+1}`;const tags=[isTeleLabel(lbl)?'telephoto':'',isUltraWideLabel(lbl)?'ultra-wide':'',isBackLabel(lbl)?'back':''].filter(Boolean).join(', ');return `<option value="${d.deviceId}">${lbl}${tags?` (${tags})`:''}</option>`}).join("");
      cameraList.style.display=devs.length>1?"block":"none";
      const savedId=localStorage.getItem("scanner.preferredDeviceId");
      let preferred=devs.find(d=>d.deviceId===savedId)||devs.filter(d=>isBackLabel(d.label)).sort((a,b)=>rankCamera(b.label)-rankCamera(a.label))[0]||devs[devs.length-1];
      chosenBackId=preferred?preferred.deviceId:(devs[0]&&devs[0].deviceId);
      if(chosenBackId)cameraList.value=chosenBackId;
      return {devs,backId:chosenBackId};
    }

    async function tuneConstraints(){try{
      const caps=currentTrack?.getCapabilities?.(); if(!caps) return;
      if(caps.focusMode?.includes?.('continuous')) await currentTrack.applyConstraints({advanced:[{focusMode:'continuous'}]});
      if(caps.exposureMode?.includes?.('continuous')) await currentTrack.applyConstraints({advanced:[{exposureMode:'continuous'}]});
    }catch{}}

    async function decodeWithDevice(deviceId){
      setStatus('–ù–∞–≤–æ–¥—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ —É —Ä–∞–º–∫—É‚Ä¶'); lastTryTs=performance.now();
      const constraints={video:{deviceId:deviceId?{exact:deviceId}:undefined,facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1440},frameRate:{ideal:30},advanced:[{focusMode:'continuous'}]},audio:false};

      reader.decodeFromConstraints(constraints, video, (result, err)=>{
        if(gotCode) return;
        if(result){
          const code=String(result.getText()||'').trim();
          const fmt=String(result.getBarcodeFormat?.()||'UNKNOWN');
          gotCode=true; lastPayload={code,fmt}; showHit(code);
          setStatus(`–ó—á–∏—Ç–∞–Ω–æ: ${code} (${fmt}). –ù–∞—Ç–∏—Å–Ω–∏ ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –±–æ—Ç¬ª.`);
          btnSend.disabled=false;
          try{navigator.vibrate&&navigator.vibrate(25)}catch(_){}
        } else if(err){
          // –ø—ñ—Å–ª—è N —Å–µ–∫—É–Ω–¥ –±–µ–∑ –∫–æ–¥—É ‚Äî –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö—ñ–¥ –≤ OCR
          const now=performance.now();
          if(ENABLE_OCR && !gotCode && now-lastTryTs>AUTO_OCR_TIMEOUT_MS){
            lastTryTs=now+1e9; // —â–æ–± –Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–ª–æ—Å—è
            runOCR();
          }
        }
      });

      let tries=0; while(!video.srcObject&&tries++<60){await new Promise(r=>setTimeout(r,100))}
      const stream=video.srcObject; currentTrack=stream?.getVideoTracks?.()[0]||null;
      updateTrackTags(); await tuneConstraints();
      if(video.paused){try{await video.play()}catch{}}
      btnRestart.disabled=false; const caps=currentTrack?.getCapabilities?.(); btnTorch.disabled=!(caps&&'torch'in caps); setupZoomControl();
      setStatus('–ù–∞–≤–æ–¥—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ —É —Ä–∞–º–∫—É‚Ä¶'); setTimeout(()=>{if(!video.srcObject||video.paused||video.readyState<2){tapOverlay.style.display='flex'}},300);
    }

    async function startCamera(){
      setStatus("–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶");
      try{
        let tries=0; while((!window.ZXing||!ZXing.BrowserMultiFormatReader)&&tries++<20){await new Promise(r=>setTimeout(r,100))}
        try{const tmp=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); tmp.getTracks().forEach(t=>t.stop())}catch{}
        await enumerateCams(); if(!chosenBackId) throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥–µ–æ–∫–∞–º–µ—Ä–∏');
        await decodeWithDevice(chosenBackId);
      }catch(e){setStatus('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä HTTPS/–¥–æ–∑–≤—ñ–ª.'); tapOverlay.style.display='flex'}
    }

    async function stopAll(){
      try{await reader.reset()}catch{} try{await video.pause()}catch{}
      const s=video.srcObject; if(s&&s.getTracks){s.getTracks().forEach(t=>{try{t.stop()}catch{}})} video.srcObject=null; currentTrack=null; btnTorch.disabled=true
    }

    // ===== OCR =====
    let ocrWorker=null;
    async function ensureOCR(){
      if(ocrWorker) return ocrWorker;
      ocrWorker = Tesseract.createWorker();
      await ocrWorker.load(); await ocrWorker.loadLanguage('eng'); await ocrWorker.initialize('eng');
      await ocrWorker.setParameters({ tessedit_char_whitelist: '0123456789/' });
      return ocrWorker;
    }

    function grabROIFrame(){
      const w=video.videoWidth, h=video.videoHeight; if(!w||!h){return null}
      const c=document.createElement('canvas'), ctx=c.getContext('2d');
      const rx=Math.round(ROI.x*w), ry=Math.round(ROI.y*h), rw=Math.round(ROI.w*w), rh=Math.round(ROI.h*h);
      c.width=rw*2; c.height=rh*2; // –∞–ø—Å–∫–µ–π–ª √ó2
      ctx.filter='contrast(1.25) brightness(1.1) saturate(1.0)';
      ctx.drawImage(video, rx, ry, rw, rh, 0, 0, c.width, c.height);
      // –ª–µ–≥–∫–∞ –±—ñ–Ω–∞—Ä–∏–∑–∞—Ü—ñ—è
      const img=ctx.getImageData(0,0,c.width,c.height), data=img.data;
      for(let i=0;i<data.length;i+=4){
        const g = (data[i]*0.3 + data[i+1]*0.59 + data[i+2]*0.11);
        const v = g>140 ? 255:0;
        data[i]=data[i+1]=data[i+2]=v;
      }
      ctx.putImageData(img,0,0);
      return c;
    }

    async function runOCR(){
      if(!ENABLE_OCR) return;
      setStatus('OCR: –∑—á–∏—Ç—É—é —Ç–µ–∫—Å—Ç‚Ä¶');
      const worker=await ensureOCR();
      const canvas=grabROIFrame(); if(!canvas){setStatus('OCR: –Ω–µ–º–∞—î –∫–∞–¥—Ä—É –≤—ñ–¥–µ–æ'); return}
      const { data:{ text } } = await worker.recognize(canvas);
      const norm=(text||'').replace(/\s+/g,'').match(/[0-9\/]+/g);
      const best = norm && norm[0] ? norm[0] : '';
      if(best && best.length>=3){
        gotCode=true; lastPayload={code:best, fmt:'OCR_TEXT'};
        showHit(best);
        setStatus(`–ó—á–∏—Ç–∞–Ω–æ —Ç–µ–∫—Å—Ç: ${best}. –ù–∞—Ç–∏—Å–Ω–∏ ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –±–æ—Ç¬ª.`);
        btnSend.disabled=false;
      }else{
        setStatus('OCR: –Ω–µ –∑–Ω–∞–π—à–æ–≤ –ø—Ä–∏–¥–∞—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É. –ü—ñ–¥—ñ–π–¥–∏ –±–ª–∏–∂—á–µ, –∑–±—ñ–ª—å—à–∏ –∑—É–º –∞–±–æ –ø–æ–≤–µ—Ä–Ω–∏ –ª–µ–π–±–ª.');
      }
    }

    // ===== –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è / –∫–µ—Ä—É–≤–∞–Ω–Ω—è =====
    btnSend.addEventListener('click', async ()=>{
      if(!lastPayload) return;
      const payload=JSON.stringify({t:'barcode',fmt:lastPayload.fmt,code:lastPayload.code});
      let sent=false;
      if(tg?.sendData){
        await new Promise(r=>setTimeout(r,SEND_DELAY_MS));
        for(let i=0;i<=RETRIES;i++){
          try{tg.sendData(payload); sent=true; break}catch{await new Promise(r=>setTimeout(r,RETRY_GAP_MS))}}
        try{tg.close&&tg.close()}catch(_){}
      }else{
        await navigator.clipboard?.writeText?.(lastPayload.code); alert(`–ö–æ–¥: ${lastPayload.code}\n(—Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ)`); sent=true;
      }
      await stopAll();
      setStatus(sent?'‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç. –ú–æ–∂–Ω–∞ –∑–∞–∫—Ä–∏–≤–∞—Ç–∏.':'‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.');
      btnSend.disabled=true;
    });

    btnRescan.addEventListener('click', async ()=>{
      gotCode=false; lastPayload=null; lastCodeEl.textContent=''; btnSend.disabled=true;
      await stopAll(); await startCamera();
    });

    btnOCR.addEventListener('click', runOCR);

    btnTorch.onclick=async()=>{try{const caps=currentTrack?.getCapabilities?.(); if(caps&&'torch'in caps){const set=currentTrack.getSettings(); await currentTrack.applyConstraints({advanced:[{torch:!set.torch}]});}}catch{}}
    btnRestart.onclick=async()=>{await stopAll(); gotCode=false; lastPayload=null; lastCodeEl.textContent=''; btnSend.disabled=true; await startCamera()}
    cameraList.onchange=async()=>{const id=cameraList.value; if(!id)return; localStorage.setItem("scanner.preferredDeviceId",id);
      chosenBackId=id; await stopAll(); gotCode=false; lastPayload=null; lastCodeEl.textContent=''; btnSend.disabled=true; await startCamera()}

    window.addEventListener('beforeunload', stopAll);
    (async()=>{video.setAttribute('playsinline',''); video.muted=true; await startCamera()})();
    btnTapStart.addEventListener('click', async()=>{tapOverlay.style.display='none'; if(!video.srcObject){await startCamera()} try{await video.play()}catch{}});
  </script>
</body>
</html>
