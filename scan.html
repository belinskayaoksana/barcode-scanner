<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ultra‑Fast Scanner — Code‑39 + QR (v1.3 CORS‑safe)</title>
  <!-- Force fresh load to avoid Telegram WebView cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- ZXing UMD (no dynamic imports; CORS‑safe) -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <style>
    :root { color-scheme: dark }
    html,body{height:100%}
    body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #stage{position:fixed;inset:0;overflow:hidden;background:#000}
    #video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #mask{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center}
    #roi{width:min(84vw,640px);height:min(38vh,320px);outline:2px solid rgba(255,255,255,.75);border-radius:18px;box-shadow:0 0 0 200vmax rgba(0,0,0,.55) inset}
    #tag{position:absolute;left:12px;bottom:12px;font-size:12px;opacity:.7;background:#111;border:1px solid #2c2c2c;border-radius:999px;padding:4px 10px}
    #status{position:absolute;top:12px;left:12px;font-size:13px;background:#111;border:1px solid #2c2c2c;border-radius:10px;padding:6px 10px;max-width:70ch}
    #canvas{display:none}
  </style>
</head>
<body>
  <main id="stage">
    <!-- iOS needs these to auto‑play camera in WebView -->
    <video id="video" playsinline webkit-playsinline autoplay muted></video>
    <div id="mask"><div id="roi"></div></div>
    <div id="status">Ініціалізація камери…</div>
    <div id="tag">Ultra‑Fast Scanner v1.3</div>
    <canvas id="canvas"></canvas>
  </main>

  <script>
    const INVENTORY_API_URL = ""; // ваш бекенд або Apps Script URL (якщо НЕ відкриваєте через Telegram WebApp)
    const API_TOKEN = "";         // опціонально, якщо потрібна авторизація на бекенді
    const SCAN_INTERVAL_MS = 100;
    const VIBRATE_MS = 20;
    const BARCODE_FORMATS = [
      'qr_code','code_39','code_93','code_128','ean_13','ean_8','upc_a','upc_e','itf','codabar','data_matrix','pdf417'
    ];

    const $ = s => document.querySelector(s);
    const status = m => $('#status').textContent = m;

    let lastSent = { value: '', at: 0 };
    function shouldSend(v){const n=Date.now();if(v===lastSent.value&&(n-lastSent.at)<4000)return!1;lastSent={value:v,at:n};return!0}

    async function sendToBot(code){
      try{
        if(!shouldSend(code))return;
        if(navigator.vibrate)navigator.vibrate(VIBRATE_MS);
        status(`Знайдено: ${code} → надсилаю…`);
        if(window?.Telegram?.WebApp){
          window.Telegram.WebApp.HapticFeedback?.impactOccurred?.('light');
          window.Telegram.WebApp.sendData(JSON.stringify({action:'handleScan',code}));
          window.Telegram.WebApp.close();
          return;
        }
        if(INVENTORY_API_URL){
          const body={action:'handleScan',source:'web_scanner',code};
          const headers={'Content-Type':'application/json'};
          if(API_TOKEN)headers['X-API-KEY']=API_TOKEN;
          const r=await fetch(INVENTORY_API_URL,{method:'POST',headers,body:JSON.stringify(body)});
          if(!r.ok)throw new Error('HTTP '+r.status);
          status('Надіслано ✅');
          setTimeout(()=>window.close(),300);
        }else status('Немає підключення до бота або API URL');
      }catch(e){console.error(e);status('Помилка: '+(e?.message||e))}
    }

    const video=$('#video');
    const canvas=$('#canvas');
    const ctx=canvas.getContext('2d',{willReadFrequently:true});

    async function chooseBackCamera(base){
      try{
        const dev=await navigator.mediaDevices.enumerateDevices();
        const vids=dev.filter(d=>d.kind==='videoinput');
        const back=vids.find(d=>/back|rear|зад/i.test(d.label));
        if(back)return{...base,video:{...base.video,deviceId:{exact:back.deviceId}}}
      }catch{}
      return base
    }

    async function startCamera(){
      if(!navigator.mediaDevices?.getUserMedia){status('Камера не підтримується');return null}
      // iOS/Safari іноді блокує autoplay → мютимо заздалегідь
      video.muted=true; video.setAttribute('muted','');
      let constraints={
        audio:false,
        video:{
          facingMode:{ideal:'environment'},
          width:{ideal:1920},
          height:{ideal:1080},
          frameRate:{ideal:30,max:60},
          advanced:[{focusMode:'continuous'}]
        }
      };
      try{
        constraints=await chooseBackCamera(constraints);
        const stream=await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject=stream;
        await video.play();
        status('Камера запущена — наведіть на код');
        return stream;
      }catch(err1){
        console.warn('Primary getUserMedia failed:',err1?.name||err1);
        // Спрощений fallback — мінімальні вимоги
        try{
          const fallbackStream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
          video.srcObject=fallbackStream; video.muted=true;
          await video.play();
          status('Камера запущена (fallback) — скануйте');
          return fallbackStream;
        }catch(err2){
          status('Камеру не вдалося запустити: '+(err2?.name||err2));
          throw err2;
        }
      }
    }

    let useNative=false;let detector=null;let zxReader=null;
    function setupDecoders(){
      if('BarcodeDetector' in window){
        try{
          const Detector=window.BarcodeDetector;
          if(Detector && Detector.getSupportedFormats){
            Detector.getSupportedFormats().then(sup=>{
              const formats=BARCODE_FORMATS.filter(f=>sup.includes(f));
              if(formats.length){
                detector=new Detector({formats});
                useNative=true;
              }
            })
          }
        }catch(e){console.warn('BarcodeDetector not usable',e)}
      }
      // ZXing UMD як fallback (CORS‑safe)
      if(!useNative && window.ZXing){
        try{ zxReader = new window.ZXing.BrowserMultiFormatReader(); }
        catch(e){ console.warn('ZXing init failed', e); }
      }
    }

    function drawFrameToCanvas(){
      const vw=video.videoWidth,vh=video.videoHeight;
      if(!vw||!vh) return null;
      canvas.width=vw; canvas.height=vh;
      ctx.drawImage(video,0,0,vw,vh);
      return{w:vw,h:vh}
    }

    async function loopScanNative(){
      try{
        const codes=await detector.detect(video);
        if(codes?.length){
          const val=(codes[0].rawValue||'').trim();
          if(val) return sendToBot(val);
        }
      }catch{}
      requestAnimationFrame(loopScanNative)
    }

    async function loopScanZXing(){
      if(!zxReader){ status('Помилка: ZXing не ініціалізовано'); return; }
      try{
        // швидка одноразова спроба
        if(zxReader.decodeOnceFromVideoElement){
          const res=await zxReader.decodeOnceFromVideoElement(video);
          if(res?.text){ const code=res.text.trim(); if(code) return sendToBot(code); }
        }
      }catch{}
      // перехід у цикл опитування
      const tick=async()=>{
        try{
          if(zxReader.decodeFromVideoElement){
            const r=await zxReader.decodeFromVideoElement(video);
            if(r?.text){ const code=r.text.trim(); if(code) return sendToBot(code); }
          }else{
            // крайній випадок: читаємо з canvas
            drawFrameToCanvas();
            const r=await zxReader.decodeFromCanvas(canvas);
            if(r?.text){ const code=r.text.trim(); if(code) return sendToBot(code); }
          }
        }catch{}
        setTimeout(tick, SCAN_INTERVAL_MS);
      };
      tick();
    }

    (async()=>{
      try{
        setupDecoders();
        await startCamera();
        // чекаємо коротко, поки detector ініціалізується
        setTimeout(()=>{
          if(useNative && detector){
            status('Скануйте… (native)');
            requestAnimationFrame(loopScanNative)
          }else{
            status('Скануйте… (ZXing)');
            loopScanZXing()
          }
        }, 80);
      }catch(e){
        console.error(e);
        status('Помилка запуску: '+(e?.name||e?.message||e))
      }
    })();
  </script>
</body>
</html>
