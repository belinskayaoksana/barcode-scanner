<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Сканер штрих-/QR-коду — v2.6 (stable send)</title>
  <style>
    :root { color-scheme: dark }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#000; color:#fff }
    header { padding:12px 16px; font-weight:600; background:#111; display:flex; justify-content:space-between; align-items:center }
    .tag { padding:2px 8px; border:1px solid #2d2d2d; border-radius:999px; font-size:12px; background:#1b1b1b; color:#cfcfcf }
    #stage { position:relative; height:56vh; background:#000; overflow:hidden }
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000 }
    #hint { position:absolute; left:50%; bottom:10px; transform:translateX(-50%); font:600 12px/1 system-ui; color:#eee;
            text-shadow:0 1px 2px #000; opacity:.95; pointer-events:none }
    #lastCode { position:absolute; left:0; right:0; top:8px; text-align:center; font:800 22px/1.25 system-ui;
                color:#00ff91; text-shadow:0 0 8px #000; pointer-events:none; word-break:break-word; padding:0 10px }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#1f2328; color:#e6edf3;
            border:1px solid #30363d; padding:10px 14px; border-radius:12px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .2s }
    #toast.show{ opacity:1 }
    #tapOverlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35) }
    #tapOverlay button{ font-size:16px; padding:12px 16px; border-radius:12px; border:1px solid #2b2b2b; background:#1a1a1a; color:#fff }
  </style>
</head>
<body>
  <header>
    <div>Сканер штрих-/QR-коду</div>
    <span class="tag">v2.6</span>
  </header>

  <div id="stage">
    <video id="video" playsinline muted autoplay></video>
    <div id="lastCode"></div>
    <div id="hint">Наведи камеру на штрих-код або QR — відправиться автоматично</div>
    <div id="tapOverlay"><button id="btnTapStart">▶️ Увімкнути камеру</button></div>
  </div>
  <div id="toast"></div>

  <!-- libs -->
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
  // ===== CONFIG =====
  const STABLE_REPEAT = 2;
  const SEND_DELAY_MS = 120;
  const ZXING_SCAN_INTERVAL_MS = 120;
  const RETRIES = 2, RETRY_GAP_MS = 250;
  const DEBUG = false;

  // ===== INIT TELEGRAM =====
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) {
    tg.expand();
    tg.ready && tg.ready();
    tg.enableClosingConfirmation && tg.enableClosingConfirmation();
  }

  const video = document.getElementById('video');
  const lastCodeEl = document.getElementById('lastCode');
  const toastEl = document.getElementById('toast');
  const tapOverlay = document.getElementById('tapOverlay');
  const btnTapStart = document.getElementById('btnTapStart');
  function toast(t, ms=1200){ toastEl.textContent=t; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }

  let currentTrack=null, gotCode=false, lastPayload=null, lastHit={code:'',t:0,times:0,fmt:''};

  function acceptCandidate(code, fmt){
    code = String(code||'').trim();
    if(!code) return;
    const now = performance.now();
    if(code===lastHit.code && (now-lastHit.t)<1200){ lastHit.times+=1; }
    else { lastHit={code, t:now, times:1, fmt}; }
    if(lastHit.times>=STABLE_REPEAT){
      gotCode=true; lastPayload={code, fmt};
      lastCodeEl.textContent=`✓ ${code}`;
      try{ navigator.vibrate && navigator.vibrate(25) }catch{}
      sendAndClose();
    }
  }

  async function startCamera(){
    try{
      const devs=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==="videoinput");
      const pref = devs.find(d=>/back|rear|environment/i.test(d.label)) || devs[0];
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ deviceId: pref?.deviceId ? { exact: pref.deviceId } : undefined, facingMode:"environment" }});
      video.srcObject = stream;
      currentTrack = stream.getVideoTracks()[0];
      const reader = new ZXing.BrowserMultiFormatReader();
      reader.decodeFromVideoDevice(pref?.deviceId, video, (res, err)=>{
        if(gotCode) return;
        if(res){
          const code = res.getText();
          const fmt = (res.barcodeFormat || '').toString();
          if(code) acceptCandidate(code, fmt);
        }
      });
      toast("Камеру увімкнено");
    }catch(e){
      toast("⚠️ Дозволь камеру / HTTPS");
      tapOverlay.style.display='flex';
    }
  }

  async function stopAll(){
    try{ video.pause(); }catch{}
    const s=video.srcObject; if(s?.getTracks) s.getTracks().forEach(t=>t.stop());
    video.srcObject=null; currentTrack=null;
  }

  function isQRFormat(fmt){ return (fmt||'').toString().toUpperCase().includes('QR'); }

  // ===== SEND DATA =====
  async function sendAndClose(){
    const payloadObj = {
      t: isQRFormat(lastPayload.fmt) ? 'qrcode' : 'barcode',
      fmt: lastPayload.fmt,
      code: lastPayload.code
    };
    const payload = JSON.stringify(payloadObj);
    let sent=false;

    try {
      if (tg && typeof tg.sendData === "function") {
        await new Promise(r=>setTimeout(r,SEND_DELAY_MS));
        for (let i=0; i<=RETRIES; i++){
          try {
            tg.sendData(payload);
            sent=true;
            break;
          } catch {
            await new Promise(r=>setTimeout(r,RETRY_GAP_MS));
          }
        }
        setTimeout(()=>{ try{ tg.close && tg.close(); }catch{} }, 250);
      }
      if(!sent){
        await navigator.clipboard?.writeText?.(lastPayload.code);
        alert(`Код: ${lastPayload.code}\n(скопійовано у буфер обміну)`);
        sent=true;
      }
      await stopAll();
      toast(sent?'✅ Відправлено':'⚠️ Помилка відправлення', sent?900:1400);
    } catch(err){
      console.error('Send error', err);
      toast('⚠️ Не вдалося відправити', 1500);
    }
  }

  // ===== EVENTS =====
  btnTapStart.onclick = async ()=>{ tapOverlay.style.display='none'; if(!video.srcObject){ await startCamera(); } try{ await video.play(); }catch{} };
  (async()=>{ video.setAttribute('playsinline',''); video.muted=true; await startCamera(); })();
  window.addEventListener('beforeunload', stopAll);
  </script>
</body>
</html>
