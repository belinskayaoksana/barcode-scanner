<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ultra‑Fast Scanner — Code‑39 + QR (v1.4 debug)</title>
  <!-- Force fresh load to avoid Telegram WebView cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ZXing UMD (no dynamic imports; CORS‑safe) -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <style>
    :root { color-scheme: dark }
    html,body{height:100%}
    body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #stage{position:fixed;inset:0;overflow:hidden;background:#000}
    /* ВІДКЛЮЧИЛИ дзеркало (було scaleX(-1)) */
    #video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #mask{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center}
    #roi{width:min(84vw,640px);height:min(38vh,320px);outline:2px solid rgba(255,255,255,.85);border-radius:18px;box-shadow:0 0 0 200vmax rgba(0,0,0,.55) inset}
    #tag{position:absolute;left:12px;bottom:12px;font-size:12px;opacity:.8;background:#111;border:1px solid #2c2c2c;border-radius:999px;padding:4px 10px}
    #status{position:absolute;top:12px;left:12px;right:12px;font-size:13px;background:#111;border:1px solid #2c2c2c;border-radius:10px;padding:6px 10px;max-width:100%}
    #canvas{display:none}
    #log{position:absolute;right:12px;bottom:48px;width:min(92vw,520px);max-height:40vh;overflow:auto;background:#0b0b0b;opacity:.9;border:1px solid #2a2a2a;border-radius:12px;padding:8px;font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
  </style>
</head>
<body>
  <main id="stage">
    <!-- iOS needs these to auto‑play camera in WebView -->
    <video id="video" playsinline webkit-playsinline autoplay muted></video>
    <div id="mask"><div id="roi"></div></div>
    <div id="status">Ініціалізація камери…</div>
    <div id="tag">Ultra‑Fast Scanner v1.4</div>
    <pre id="log"></pre>
    <canvas id="canvas"></canvas>
  </main>

  <script>
    const VERSION = '1.4';
    const INVENTORY_API_URL = ""; // ваш бекенд або Apps Script URL (якщо НЕ відкриваєте через Telegram WebApp)
    const API_TOKEN = "";         // опціонально, якщо потрібна авторизація на бекенді
    const SCAN_INTERVAL_MS = 120;
    const VIBRATE_MS = 20;
    const BARCODE_FORMATS = [
      'qr_code','code_39','code_93','code_128','ean_13','ean_8','upc_a','upc_e','itf','codabar','data_matrix','pdf417'
    ];

    const $ = s => document.querySelector(s);
    const status = m => { $('#status').textContent = m; log('STATUS', m); };
    function log(tag, msg){
      const el=$('#log');
      const line = `[${new Date().toLocaleTimeString()}] ${tag}: ${msg}`;
      console.log(line);
      el.textContent = (el.textContent+"\n"+line).slice(-4000);
    }

    // ---- CACHE BUSTERS (ServiceWorker + Caches API + localStorage hint) ----
    (async()=>{
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          for(const r of regs){ await r.unregister(); log('CACHE','ServiceWorker unregistered'); }
        }
        if('caches' in window){
          const keys = await caches.keys();
          for(const k of keys){ await caches.delete(k); log('CACHE', `Cache deleted: ${k}`); }
        }
        localStorage.setItem('scanner_version', VERSION);
      }catch(e){ log('CACHE','skip: '+(e.message||e)); }
    })();

    let lastSent = { value: '', at: 0 };
    function shouldSend(v){const n=Date.now();if(v===lastSent.value&&(n-lastSent.at)<4000)return!1;lastSent={value:v,at:n};return!0}

    async function sendToBot(code){
      try{
        if(!shouldSend(code))return;
        if(navigator.vibrate)navigator.vibrate(VIBRATE_MS);
        status(`Знайдено: ${code} → надсилаю…`);
        if(window?.Telegram?.WebApp){
          window.Telegram.WebApp.HapticFeedback?.impactOccurred?.('light');
          window.Telegram.WebApp.sendData(JSON.stringify({action:'handleScan',code}));
          window.Telegram.WebApp.close();
          return;
        }
        if(INVENTORY_API_URL){
          const body={action:'handleScan',source:'web_scanner',code};
          const headers={'Content-Type':'application/json'};
          if(API_TOKEN)headers['X-API-KEY']=API_TOKEN;
          const r=await fetch(INVENTORY_API_URL,{method:'POST',headers,body:JSON.stringify(body)});
          if(!r.ok)throw new Error('HTTP '+r.status);
          status('Надіслано ✅');
          setTimeout(()=>window.close(),300);
        }else status('Немає підключення до бота або API URL');
      }catch(e){console.error(e);status('Помилка надсилання: '+(e?.message||e))}
    }

    const video=$('#video');
    const canvas=$('#canvas');
    const ctx=canvas.getContext('2d',{willReadFrequently:true});

    async function enumerateCams(){
      try{
        const dev=await navigator.mediaDevices.enumerateDevices();
        const vids=dev.filter(d=>d.kind==='videoinput');
        log('DEVICES', JSON.stringify(vids.map(v=>({label:v.label, id:v.deviceId}))))
        return vids;
      }catch(e){ log('DEVICES','err '+(e.message||e)); return []; }
    }

    async function chooseBackCamera(base){
      const vids=await enumerateCams();
      const back=vids.find(d=>/back|rear|зад|environment/i.test(d.label));
      if(back){ log('CAM','use back: '+back.label); return { ...base, video: { ...base.video, deviceId: { exact: back.deviceId } } } }
      log('CAM','no explicit back camera, use defaults');
      return base
    }

    async function startCamera(){
      if(!navigator.mediaDevices?.getUserMedia){status('Камера не підтримується');return null}
      video.muted=true; video.setAttribute('muted','');
      let constraints={
        audio:false,
        video:{
          facingMode:{ideal:'environment'},
          width:{ideal:1920},
          height:{ideal:1080},
          frameRate:{ideal:30,max:60},
          advanced:[{focusMode:'continuous'}]
        }
      };
      try{
        constraints=await chooseBackCamera(constraints);
        log('GUM','constraints '+JSON.stringify(constraints.video||{}));
        const stream=await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject=stream;
        await video.play();
        status('Камера запущена — наведіть на код');
        return stream;
      }catch(err1){
        log('GUM','primary failed: '+(err1?.name||err1));
        try{
          const fallbackStream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
          video.srcObject=fallbackStream; video.muted=true;
          await video.play();
          status('Камера запущена (fallback) — скануйте');
          return fallbackStream;
        }catch(err2){
          status('Камеру не вдалося запустити: '+(err2?.name||err2));
          throw err2;
        }
      }
    }

    let useNative=false;let detector=null;let zxReader=null;
    function setupDecoders(){
      if('BarcodeDetector' in window){
        try{
          const Detector=window.BarcodeDetector;
          if(Detector && Detector.getSupportedFormats){
            Detector.getSupportedFormats().then(sup=>{
              const formats=BARCODE_FORMATS.filter(f=>sup.includes(f));
              log('Detector formats', JSON.stringify(formats));
              if(formats.length){
                detector=new Detector({formats});
                useNative=true;
              }
            })
          }
        }catch(e){ log('Detector','not usable '+(e.message||e)); }
      }
      if(!useNative && window.ZXing){
        try{
          zxReader = new window.ZXing.BrowserMultiFormatReader();
          // Хінти для кращого розпізнавання
          const hints = new Map();
          hints.set(window.ZXing.DecodeHintType.TRY_HARDER, true);
          hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            window.ZXing.BarcodeFormat.QR_CODE,
            window.ZXing.BarcodeFormat.CODE_39,
            window.ZXing.BarcodeFormat.CODE_128,
            window.ZXing.BarcodeFormat.EAN_13,
            window.ZXing.BarcodeFormat.EAN_8,
            window.ZXing.BarcodeFormat.UPC_A,
            window.ZXing.BarcodeFormat.UPC_E,
            window.ZXing.BarcodeFormat.ITF,
            window.ZXing.BarcodeFormat.CODABAR,
            window.ZXing.BarcodeFormat.DATA_MATRIX,
            window.ZXing.BarcodeFormat.PDF_417
          ]);
          zxReader?.setHints?.(hints);
          log('ZXing','initialized with hints');
        }catch(e){ log('ZXing','init fail '+(e.message||e)); }
      }
    }

    function drawFrameToCanvas(){
      const vw=video.videoWidth,vh=video.videoHeight;
      if(!vw||!vh) return null;
      canvas.width=vw; canvas.height=vh;
      ctx.drawImage(video,0,0,vw,vh);
      return{w:vw,h:vh}
    }

    async function loopScanNative(){
      try{
        const codes=await detector.detect(video);
        if(codes?.length){
          const val=(codes[0].rawValue||'').trim();
          log('NATIVE','hit '+val);
          if(val) return sendToBot(val);
        }
      }catch(e){ log('NATIVE','err '+(e.message||e)); }
      requestAnimationFrame(loopScanNative)
    }

    async function loopScanZXing(){
      if(!zxReader){ status('Помилка: ZXing не ініціалізовано'); return; }
      try{
        if(zxReader.decodeOnceFromVideoElement){
          const res=await zxReader.decodeOnceFromVideoElement(video);
          if(res?.text){ const code=res.text.trim(); log('ZX','once '+code); if(code) return sendToBot(code); }
        }
      }catch(e){ log('ZX','once miss '+(e.message||e)); }
      const tick=async()=>{
        try{
          if(zxReader.decodeFromVideoElement){
            const r=await zxReader.decodeFromVideoElement(video);
            if(r?.text){ const code=r.text.trim(); log('ZX','loop '+code); if(code) return sendToBot(code); }
          }else{
            drawFrameToCanvas();
            const r=await zxReader.decodeFromCanvas(canvas);
            if(r?.text){ const code=r.text.trim(); log('ZX','canvas '+code); if(code) return sendToBot(code); }
          }
        }catch(e){ /* очікувані промахи */ }
        setTimeout(tick, SCAN_INTERVAL_MS);
      };
      tick();
    }

    (async()=>{
      try{
        setupDecoders();
        await startCamera();
        setTimeout(()=>{
          if(useNative && detector){
            status('Скануйте… (native)');
            requestAnimationFrame(loopScanNative)
          }else{
            status('Скануйте… (ZXing)');
            loopScanZXing()
          }
        }, 100);
      }catch(e){
        console.error(e);
        status('Помилка запуску: '+(e?.name||e?.message||e))
      }
    })();
  </script>
</body>
</html>
