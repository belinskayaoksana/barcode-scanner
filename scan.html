<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—É ‚Äî multi (auto camera) v1.4</title>
  <style>
    :root{color-scheme:dark}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#000;color:#fff}
    header{padding:12px 16px;font-weight:600;background:#111;display:flex;gap:8px;align-items:center;justify-content:space-between}
    #video{width:100%;height:48vh;object-fit:cover;background:#000}
    #bar{display:flex;gap:8px;align-items:center;padding:10px 16px;background:#111;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:10px;border:1px solid #444;background:#1b1b1b;color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    #status{padding:8px 16px;color:#ccc;background:#111}
    #cameraList{padding:6px 8px;border-radius:8px;border:1px solid #444;background:#1b1b1b;color:#fff}
    #log{height:32vh;overflow:auto;background:#0c0c0c;border-top:1px solid #333;font-family:ui-monospace,Consolas,monospace;padding:8px 12px;white-space:pre-wrap}
    .tag{display:inline-block;margin:2px 4px 2px 0;padding:2px 6px;border:1px solid #444;border-radius:999px;font-size:12px;background:#1b1b1b}
    input[type="range"]{accent-color:#fff}
    #lastCode{position:absolute;left:0;right:0;top:8px;text-align:center;font:600 18px/1.2 system-ui;color:#0f0;text-shadow:0 0 6px #000}
  </style>
</head>
<body>
  <header>
    <div>–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ ‚Äî DEBUG (auto camera)</div>
    <span class="tag" id="tagVer">v1.4</span>
  </header>

  <div id="lastCode"></div>
  <video id="video" playsinline muted autoplay></video>

  <!-- iOS autoplay/touch overlay -->
  <div id="tapOverlay" style="position:absolute;left:0;right:0;top:56px;height:48vh;display:none;align-items:center;justify-content:center;pointer-events:auto;background:rgba(0,0,0,.35);">
    <button id="btnTapStart" style="font-size:16px;padding:10px 14px;border-radius:12px;border:1px solid #666;background:#1b1b1b;color:#fff">‚ñ∂Ô∏è –¢–æ—Ä–∫–Ω–∏—Å—å, —â–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
  </div>

  <div id="bar">
    <button id="btnTorch" disabled>üî¶ Torch</button>
    <button id="btnRestart" disabled>üîÅ Restart</button>
    <select id="cameraList" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É"></select>
    <input id="zoom" type="range" min="1" max="1" step="0.1" style="width:160px; display:none;">
    <button id="btnDownload">‚¨áÔ∏è Download logs</button>
    <span class="tag" id="tagFacing">facing: ?</span>
    <span class="tag" id="tagRes">res: ?</span>
    <span class="tag" id="tagTorch">torch: ?</span>
    <span class="tag" id="tagZoom">zoom: n/a</span>
  </div>

  <div id="status">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>
  <div id="log"></div>

  <!-- –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è ZXing (umd) -->
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // ---- Version ----
    const VERSION = 'v1.4';

    // ---- Logger ----
    const logEl = document.getElementById('log');
    const logs = [];
    function log(...args){
      const line = args.map(v => { try { return typeof v === 'string' ? v : JSON.stringify(v); } catch { return String(v); } }).join(' ');
      const ts = new Date().toISOString().split('T')[1].replace('Z','');
      const msg = `[${ts}] ${line}`;
      logs.push(msg);
      console.log(msg);
      if (logEl) { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }
    }
    window.onerror = (m, s, l, c, e) => log("ERROR", m, s, l, c, e && e.stack);

    document.getElementById('btnDownload').addEventListener('click', ()=>{
      const blob = new Blob([logs.join("\n")], {type:"text/plain"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `scanner_logs_${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // ---- Telegram bridge ----
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) { tg.expand(); tg.ready && tg.ready(); log("TG WebApp detected", tg.platform, tg.version, VERSION); }
    else { log("TG WebApp NOT detected ‚Äî –≤—ñ–¥–∫—Ä–∏–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç—ñ"); }

    // ---- UI refs ----
    const video       = document.getElementById('video');
    const statusEl    = document.getElementById('status');
    const btnTorch    = document.getElementById('btnTorch');
    const btnRestart  = document.getElementById('btnRestart');
    const cameraList  = document.getElementById('cameraList');
    const tagFacing   = document.getElementById('tagFacing');
    const tagRes      = document.getElementById('tagRes');
    const tagTorch    = document.getElementById('tagTorch');
    const zoomEl      = document.getElementById('zoom');
    const tagZoom     = document.getElementById('tagZoom');
    const tapOverlay  = document.getElementById('tapOverlay');
    const btnTapStart = document.getElementById('btnTapStart');
    const lastCodeEl  = document.getElementById('lastCode');

    function setStatus(t){ statusEl.textContent = t; log("STATUS:", t); }
    function showTapOverlay(show){ tapOverlay.style.display = show ? 'flex' : 'none'; }
    function showHit(code){
      lastCodeEl.textContent = `‚úì ${code}`;
      lastCodeEl.style.color = '#0f0';
      setTimeout(()=> lastCodeEl.textContent = '', 2500);
    }

    // ---- ZXing setup (multi-format + hints) ----
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.UPC_A,
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.ITF,       // ITF-14
      ZXing.BarcodeFormat.CODE_39
    ]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
    hints.set(ZXing.DecodeHintType.ASSUME_GS1, true);
    const reader = new ZXing.BrowserMultiFormatReader(hints, 500);

    let currentTrack = null;
    let chosenBackId = null;
    let sentOnce = false;

    // ---- Decode error telemetry (–∑—Ä–æ–∑—É–º—ñ—Ç–∏ —á–æ–º—É –Ω–µ —á–∏—Ç–∞—î) ----
    const errStats = { NotFound:0, Checksum:0, Format:0, Other:0 };
    let lastErrLogTs = 0;
    function onDecodeError(err){
      if (!err) return;
      if (err instanceof ZXing.NotFoundException) errStats.NotFound++;
      else if (err instanceof ZXing.ChecksumException) errStats.Checksum++;
      else if (err instanceof ZXing.FormatException) errStats.Format++;
      else errStats.Other++;

      // –ª–æ–≥ —Ä–∞–∑ –Ω–∞ 1.5—Å, —â–æ–± –Ω–µ —Å–ø–∞–º–∏—Ç–∏
      const now = performance.now();
      if (now - lastErrLogTs > 1500){
        lastErrLogTs = now;
        const hint =
          errStats.Checksum > errStats.NotFound ? "‚Üí –ü–æ—Ä–∞–¥–∞: –¥–æ–¥–∞–π —Å–≤—ñ—Ç–ª–∞/–Ω–∞–±–ª–∏–∑—å ‚Äî –∑–±—ñ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ—ó —Å—É–º–∏." :
          errStats.Format   > errStats.NotFound ? "‚Üí –ü–æ—Ä–∞–¥–∞: —Ñ–æ—Ä–º–∞—Ç –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä, —â–æ —Ü–µ EAN/UPC/ITF/Code128." :
          "‚Üí –ü–æ—Ä–∞–¥–∞: –Ω–µ–º–∞—î –ø–∞—Ç–µ—Ä–Ω—É ‚Äî —Ç—Ä–∏–º–∞–π —Ä—ñ–≤–Ω–æ, —â–æ–± —à—Ç—Ä–∏—Ö–∏ –±—É–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ, –∑–±—ñ–ª—å—à –º–∞—Å—à—Ç–∞–±.";
        log(`decode stats NotFound=${errStats.NotFound} Checksum=${errStats.Checksum} Format=${errStats.Format} Other=${errStats.Other}. ${hint}`);
      }
    }

    function updateTrackTags(){
      try{
        const s = currentTrack?.getSettings?.() || {};
        tagFacing.textContent = `facing: ${s.facingMode || "?"}`;
        tagRes.textContent    = `res: ${s.width||"?"}x${s.height||"?"}`;
        const caps = currentTrack?.getCapabilities?.();
        tagTorch.textContent  = `torch: ${caps && 'torch' in caps ? 'yes' : 'no'}`;
      }catch(_){ }
    }

    function setupZoomControl(){
      try {
        const caps = currentTrack?.getCapabilities?.();
        if (caps?.zoom) {
          zoomEl.min = caps.zoom.min ?? 1;
          zoomEl.max = caps.zoom.max ?? 5;
          zoomEl.step = caps.zoom.step ?? 0.1;
          const desired = Math.min(caps.zoom.max ?? 2.5, Math.max(caps.zoom.min ?? 1.5, 2));
          zoomEl.value = currentTrack.getSettings().zoom ?? desired;
          zoomEl.style.display = 'inline-block';
          tagZoom.textContent = `zoom: ${zoomEl.value}`;
          currentTrack.applyConstraints({ advanced: [{ zoom: Number(zoomEl.value) }] }).catch(()=>{});
        } else {
          zoomEl.style.display = 'none';
          tagZoom.textContent = 'zoom: n/a';
        }
      } catch { }
    }

    zoomEl.addEventListener('input', async () => {
      try {
        await currentTrack.applyConstraints({ advanced: [{ zoom: Number(zoomEl.value) }] });
        tagZoom.textContent = `zoom: ${zoomEl.value}`;
        log("Zoom set to", zoomEl.value);
      } catch(e){ log("zoom error", e); }
    });

    // ---- Camera helpers ----
    function isUltraWideLabel(lbl){ return /ultra|ultra[- ]?wide|uw|0\.5x|0,5x|–Ω–∞–¥—à–∏—Ä/i.test(lbl||''); }
    function isTeleLabel(lbl){ return /tele|telephoto|2x|3x|5x|10x/i.test(lbl||''); }
    function isBackLabel(lbl){ return /back|rear|environment|—Ç–∏–ª–æ–≤|–∑–∞–¥–Ω/i.test(lbl||''); }

    function rankCamera(label){
      // 3 ‚Äî –Ω–∞–π–∫—Ä–∞—â–∞ (telephoto), 2 ‚Äî –∑–≤–∏—á–∞–π–Ω–∞ –∑–∞–¥–Ω—è, 1 ‚Äî ultra-wide, 0 ‚Äî —ñ–Ω—à—ñ
      if (isTeleLabel(label) && isBackLabel(label)) return 3;
      if (isBackLabel(label) && !isUltraWideLabel(label)) return 2;
      if (isUltraWideLabel(label)) return 1;
      return 0;
    }

    async function enumerateCams(){
      const devs = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === "videoinput");
      log("Devices:", devs.map(d => ({label:d.label, deviceId:d.deviceId, groupId:d.groupId})));

      // render select
      cameraList.innerHTML = devs.map((d,i)=>{
        const lbl = d.label || `–ö–∞–º–µ—Ä–∞ ${i+1}`;
        const tags = [
          isTeleLabel(lbl) ? 'telephoto' : '',
          isUltraWideLabel(lbl) ? 'ultra-wide' : '',
          isBackLabel(lbl) ? 'back' : ''
        ].filter(Boolean).join(', ');
        const hint = tags ? ` (${tags})` : '';
        return `<option value="${d.deviceId}">${lbl}${hint}</option>`;
      }).join("");
      cameraList.style.display = devs.length > 1 ? "block" : "none";

      const savedId = localStorage.getItem("scanner.preferredDeviceId");
      let preferred =
          devs.find(d => d.deviceId === savedId)
       || devs.filter(d => isBackLabel(d.label)).sort((a,b)=>rankCamera(b.label)-rankCamera(a.label))[0]
       || devs[devs.length - 1];

      chosenBackId = preferred ? preferred.deviceId : (devs[0] && devs[0].deviceId);
      log("Chosen deviceId:", chosenBackId, "label:", preferred && preferred.label, "rank:", preferred && rankCamera(preferred.label));
      if (chosenBackId) cameraList.value = chosenBackId;
      return {devs, backId: chosenBackId};
    }

    async function tuneConstraintsForiOS(){
      try {
        const caps = currentTrack?.getCapabilities?.();
        if (!caps) return;
        // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑—É–º —ñ –∞–≤—Ç–æ—Ñ–æ–∫—É—Å
        if (caps.zoom) {
          const mid = Math.min(caps.zoom.max || 2.5, Math.max(caps.zoom.min || 1.5, 2));
          await currentTrack.applyConstraints({ advanced: [{ zoom: mid }] });
          tagZoom.textContent = `zoom: ${mid}`;
        }
        if (caps.focusMode?.includes?.('continuous')) {
          await currentTrack.applyConstraints({ advanced:[{ focusMode:'continuous' }] });
        }
      } catch(e){ log('constraints tune error', e?.message); }
    }

    async function decodeWithDevice(deviceId){
      setStatus('–ó–∞–ø—É—Å–∫–∞—é –¥–µ–∫–æ–¥–µ—Ä‚Ä¶');
      const constraints = {
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          facingMode: { ideal: 'environment' },
          width:  { ideal: 1920 },
          height: { ideal: 1080 },
          frameRate: { ideal: 30 },
          advanced: [ { focusMode: 'continuous' } ]
        },
        audio: false
      };

      // 1) –°—Ç–∞—Ä—Ç –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è –ë–ï–ó await (–ø–æ—Å—Ç—ñ–π–Ω–∏–π —Ü–∏–∫–ª) + —Ä–æ–∑—à–∏—Ä–µ–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
      reader.decodeFromConstraints(constraints, video, (result, err) => {
        if (sentOnce) return;
        if (result){
          const code = String(result.getText()||'').trim();
          const fmt  = String(result.getBarcodeFormat?.() || 'UNKNOWN');
          sentOnce = true;
          showHit(code);
          handleCode(code, fmt);
        } else if (err) {
          onDecodeError(err);
        }
      });

      // 2) –ß–µ–∫–∞—î–º–æ –ø–æ—è–≤—É –ø–æ—Ç–æ–∫—É —É <video>, —Ç–æ–¥—ñ –≤–º–∏–∫–∞—î–º–æ UI
      await (async function waitForStream(){
        let tries = 0;
        while (!video.srcObject && tries++ < 60) {
          await new Promise(r => setTimeout(r, 100));
        }
      })();

      const stream = video.srcObject;
      currentTrack = stream?.getVideoTracks?.()[0] || null;
      updateTrackTags();
      await tuneConstraintsForiOS();

      if (video.paused) { try { await video.play(); } catch(_){} }
      btnRestart.disabled = false;
      const caps = currentTrack?.getCapabilities?.();
      btnTorch.disabled = !(caps && 'torch' in caps);
      setupZoomControl();

      setStatus('–ù–∞–≤–æ–¥—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ —É —Ä–∞–º–∫—É‚Ä¶');

      // –Ø–∫—â–æ autoplay –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ (iOS), –ø–æ–∫–∞–∂–µ–º–æ –æ–≤–µ—Ä–ª–µ–π
      setTimeout(()=>{ if (!video.srcObject || video.paused || video.readyState < 2){ log('Autoplay blocked: showing tap overlay'); showTapOverlay(true); } }, 300);
    }

    async function startCamera(){
      setStatus("–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶");
      try {
        // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ZXing
        let tries = 0;
        while ((!window.ZXing || !ZXing.BrowserMultiFormatReader) && tries++ < 20){
          await new Promise(r=>setTimeout(r,100));
        }

        // –ü—Ä–æ–±–Ω–∏–π –¥–æ—Å—Ç—É–ø (–¥–ª—è –Ω–∞–∑–≤ –∫–∞–º–µ—Ä —É –¥–µ—è–∫–∏—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö/iOS)
        try {
          const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          tmp.getTracks().forEach(t=>t.stop());
          log('Permission probe ok');
        } catch(e){ log('Permission probe error', e?.name, e?.message); }

        await enumerateCams();
        if (!chosenBackId) throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥–µ–æ–∫–∞–º–µ—Ä–∏');

        try {
          await decodeWithDevice(chosenBackId);
        } catch(e1){
          log('decodeWithDevice failed', e1?.message);
          // Fallback: decodeFromVideoDevice
          try {
            reader.decodeFromVideoDevice(chosenBackId, video, (result, err)=>{
              if (sentOnce) return;
              if (result){
                const code = String(result.getText()||'').trim();
                const fmt  = String(result.getBarcodeFormat?.() || 'UNKNOWN');
                sentOnce = true; showHit(code); handleCode(code, fmt);
              } else if (err) { onDecodeError(err); }
            });
            log('fallback decodeFromVideoDevice started');
            const stream = video.srcObject; currentTrack = stream?.getVideoTracks?.()[0] || null;
            updateTrackTags(); setupZoomControl(); await tuneConstraintsForiOS();
            setStatus('–ù–∞–≤–æ–¥—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ —É —Ä–∞–º–∫—É‚Ä¶');
          } catch(e2){
            log('decodeFromVideoDevice failed', e2?.message);
            // Fallback: –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—ñ–∫ —ñ –¥–µ–∫–æ–¥ –∑ –µ–ª–µ–º–µ–Ω—Ç–∞
            const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId:{ exact: chosenBackId } }, audio:false });
            video.srcObject = stream; await video.play().catch(()=>{});
            currentTrack = stream.getVideoTracks()[0];
            updateTrackTags(); setupZoomControl(); await tuneConstraintsForiOS();
            setStatus('–ö–∞–º–µ—Ä–∞ –ø—Ä–∞—Ü—é—î, –∑–∞–ø—É—Å–∫–∞—é –ø–æ—à—É–∫ –∫–æ–¥—É‚Ä¶');
            reader.decodeFromVideoElement(video).then(result=>{
              if (sentOnce) return;
              sentOnce = true;
              const code = String(result.getText()||'').trim();
              const fmt  = String(result.getBarcodeFormat?.() || 'UNKNOWN');
              showHit(code); handleCode(code, fmt);
            }).catch(err=>{ onDecodeError(err); });
          }
        }
      } catch (e) {
        log('startCamera error', e?.message || e);
        setStatus('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä HTTPS/–¥–æ–∑–≤—ñ–ª.');
        showTapOverlay(true);
      }
    }

    async function stopAll(){
      try { await reader.reset(); } catch(e){ log("reader.reset error", e); }
      try { await video.pause(); } catch(e){ log("video.pause error", e); }
      const stream = video.srcObject;
      if (stream && stream.getTracks) { stream.getTracks().forEach(t=>{ try{ t.stop(); }catch(_){} }); }
      video.srcObject = null;
      currentTrack = null;
      btnTorch.disabled = true;
      log("Stopped all tracks");
    }

    function handleCode(code, fmt){
      setStatus(`–ó—á–∏—Ç–∞–Ω–æ: ${code} (${fmt}). –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –≤ –±–æ—Ç‚Ä¶`);
      try { navigator.vibrate && navigator.vibrate(25); } catch(_){}

      const payload = JSON.stringify({ t:'barcode', fmt, code });

      (async ()=>{
        try{
          if (tg?.sendData){
            let ok = false;
            try { tg.sendData(payload); ok = true; log('tg.sendData sent', payload); }
            catch (e) { log('tg.sendData ERROR', e?.message || e); }
            // –î–æ–¥–∞—Ç–∫–æ–≤–µ –≤—ñ–∫–Ω–æ –¥–ª—è iOS, —â–æ–± –±–æ—Ç –≤—Å—Ç–∏–≥ –ø—Ä–∏–π–Ω—è—Ç–∏ –¥–∞–Ω—ñ
            setTimeout(()=>{ try{ tg.close && tg.close(); }catch(_){ } }, ok ? 450 : 700);
          } else {
            await navigator.clipboard?.writeText?.(code);
            alert(`–ö–æ–¥: ${code}\n(–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É)`);
          }
        } finally {
          await stopAll();
        }
      })();
    }

    // UI events
    btnTorch.addEventListener('click', async () => {
      try{
        const caps = currentTrack?.getCapabilities?.();
        if (caps && 'torch' in caps){
          const set = currentTrack.getSettings();
          await currentTrack.applyConstraints({ advanced: [{ torch: !set.torch }] });
          log("Torch toggled");
        } else { log("Torch not supported"); }
      }catch(e){ log("Torch error", e); }
    });

    document.getElementById('btnRestart').addEventListener('click', async () => {
      await stopAll(); sentOnce = false;
      errStats.NotFound = errStats.Checksum = errStats.Format = errStats.Other = 0;
      await startCamera();
    });

    cameraList.addEventListener('change', async () => {
      const id = cameraList.value; if (!id) return;
      localStorage.setItem("scanner.preferredDeviceId", id);
      log("Manual camera switch to", id);
      chosenBackId = id;
      await stopAll(); sentOnce = false;
      errStats.NotFound = errStats.Checksum = errStats.Format = errStats.Other = 0;
      await startCamera();
    });

    window.addEventListener('beforeunload', stopAll);

    // Auto Start
    (async ()=>{
      log('UA:', navigator.userAgent);
      document.getElementById('tagVer').textContent = VERSION;
      video.setAttribute('playsinline',''); video.muted = true;
      await startCamera();
    })();

    // Tap overlay handler ‚Äî —è–≤–Ω–∏–π –∂–µ—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è iOS
    btnTapStart.addEventListener('click', async ()=>{
      showTapOverlay(false);
      if (!video.srcObject) { await startCamera(); }
      try { await video.play(); } catch(e){ log('manual play error', e?.message||e); }
    });
  </script>
</body>
</html>
