<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—É</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{padding:12px 16px;font-weight:600}
    #wrap{display:flex;flex-direction:column;height:100vh}
    #video{width:100%;max-height:70vh;background:#000}
    #status{padding:10px 16px;color:#555}
    #bar{display:flex;gap:8px;padding:10px 16px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#f6f7f8;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
  </style>
</head>
<body>
  <div id="wrap">
    <header>–°–∫–∞–Ω—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥ (Code-128 / EAN-13)</header>
    <video id="video" playsinline></video>
    <div id="bar">
      <button id="toggleTorch" disabled>üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
      <button id="restart" disabled>üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏</button>
    </div>
    <div id="status">–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶</div>
  </div>

  <!-- ZXing (—á–∏—Ç–∞–Ω–Ω—è 1D/2D –∫–æ–¥—ñ–≤) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Telegram Mini App
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) tg.expand();

    const video   = document.getElementById('video');
    const status  = document.getElementById('status');
    const btnTorch = document.getElementById('toggleTorch');
    const btnRestart = document.getElementById('restart');

    const reader = new ZXing.BrowserMultiFormatReader();
    let currentDeviceId = null;
    let currentTrack = null;
    let stopping = false;

    async function startScanner(){
      status.textContent = '–ì–æ—Ç—É—é –∫–∞–º–µ—Ä—É‚Ä¶';
      btnTorch.disabled = true; btnRestart.disabled = true;

      try {
        // –ø–µ—Ä–µ–ª—ñ–∫ –∫–∞–º–µ—Ä —ñ –≤–∏–±—ñ—Ä —Ç–∏–ª–æ–≤–æ—ó
        const devices = await reader.listVideoInputDevices();
        if (!devices.length) throw new Error('–ö–∞–º–µ—Ä—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');

        const back = devices.find(d => /back|rear|environment/i.test(d.label));
        currentDeviceId = (back || devices[0]).deviceId;

        // –∑–∞–ø—É—Å–∫ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è –∑ –≤—ñ–¥–µ–æ
        await reader.decodeFromVideoDevice(currentDeviceId, video, (result, err) => {
          if (result && !stopping) {
            stopping = true;                     // —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–≤—Ç–æ—Ä—ñ–≤
            const code = String(result.getText() || '').trim();
            status.textContent = `–ó—á–∏—Ç–∞–Ω–æ: ${code}`;
            try { navigator.vibrate && navigator.vibrate(60); } catch(e){}
            // –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ–¥ —É Telegram-–±–æ—Ç
            if (tg) tg.sendData(code);
            // –∑—É–ø–∏–Ω–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
            setTimeout(stopScanner, 200);
          }
        });

        // –¥–æ—Å—Ç—É–ø –¥–æ —Ç—Ä–µ–∫—É –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ª—ñ—Ö—Ç–∞—Ä–∏–∫–æ–º
        const stream = video.srcObject;
        currentTrack = stream && stream.getVideoTracks ? stream.getVideoTracks()[0] : null;

        // —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É –ª—ñ—Ö—Ç–∞—Ä–∏–∫–∞, —è–∫—â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è
        if (currentTrack) {
          const caps = currentTrack.getCapabilities && currentTrack.getCapabilities();
          if (caps && 'torch' in caps) {
            btnTorch.disabled = false;
          }
        }
        btnRestart.disabled = false;
        status.textContent = '–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ (—Ç—Ä–∏–º–∞–π—Ç–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –¥–ª—è 1D).';
      } catch (e) {
        console.error(e);
        status.textContent = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —î HTTPS —ñ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –∫–∞–º–µ—Ä—É.';
      }
    }

    async function stopScanner(){
      try { await reader.reset(); } catch(e){}
      if (currentTrack) { try { currentTrack.stop(); } catch(e){} }
      btnTorch.disabled = true;
    }

    btnTorch.addEventListener('click', async () => {
      if (!currentTrack) return;
      try {
        const caps = currentTrack.getCapabilities();
        if (caps && 'torch' in caps) {
          const settings = currentTrack.getSettings();
          const isOn = settings.torch === true;
          await currentTrack.applyConstraints({ advanced: [{ torch: !isOn }] });
        }
      } catch(e){ console.warn('Torch not supported', e); }
    });

    btnRestart.addEventListener('click', async () => {
      stopping = false;
      await stopScanner();
      await startScanner();
    });

    // –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç
    startScanner();
  </script>
</body>
</html>
